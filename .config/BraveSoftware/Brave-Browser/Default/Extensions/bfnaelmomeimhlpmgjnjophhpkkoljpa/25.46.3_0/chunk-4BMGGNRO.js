import{Ba as Xt,I as B,J as z,K as ye,M as ee,N as Jt,O as Yt,R as ke,_ as Qt}from"./chunk-TAPPRV2Q.js";import{ca as Wt,j as jt,jc as Kt,ub as Gt}from"./chunk-KLKDJF5S.js";import{Ab as be,Mb as Ie,Rc as Ee,Uc as Ce,g as Ae,yc as fe}from"./chunk-BQE2SXP7.js";import{Bc as w,Cc as f,Fc as m,Lb as ie,Ld as Ht,Nb as O,Ob as yt,Qb as _t,Qd as zt,Rb as Ut,Sb as b,Uc as qt,Y as se,ba as de,h as vt,he as $t,i as xt,l as Mt,m as Lt,ma as me,n as Ot,qa as Nt,v as Bt,w as G,x as ae}from"./chunk-L3JU23Z5.js";import{h as ge}from"./chunk-5HNKNX3S.js";import{R as Vt,a as ft,b as Ks,d as g,l as Q}from"./chunk-R3MCCTIW.js";import{h as F,k as L}from"./chunk-VL3IRAUM.js";import{g as o}from"./chunk-FA7LVEFF.js";import{a,g as q,i as h,m as Buffer,n as l}from"./chunk-WKJYWAXG.js";h();l();var Ws=q(Ks());var Z=q(ft());h();l();h();l();var N=o.string().regex(/^\d*\.?\d+$/,"Invalid numeric string"),Fe=o.string().regex(/^-?\d*\.?\d+$/,"Invalid signed numeric string"),Zt=o.object({accountValue:Fe,totalMarginUsed:N,totalNtlPos:N,totalRawUsd:Fe}),Mi=o.object({marginSummary:Zt,withdrawable:N,assetPositions:o.array(o.any()).optional(),crossMaintenanceMarginUsed:N.optional(),crossMarginSummary:Zt.optional(),guaranteedUntil:o.number().optional(),isAccountSolvent:o.boolean().optional(),pendingCashAdjusts:o.array(o.any()).optional(),totalCrossCollateral:N.optional(),totalIsolatedCollateral:N.optional(),totalMaintenanceMarginUsed:N.optional()}),es=o.object({coin:o.string(),side:o.enum(["B","A"]),limitPx:N,sz:N,oid:o.number(),timestamp:o.number(),origSz:N,cloid:o.string().optional()}),Li=o.array(es),Vs=o.object({position:es,status:o.string(),statusTimestamp:o.number()}),Oi=o.array(Vs),Js=o.object({status:o.literal("ok"),response:o.object({type:o.string()}).optional()}),ts=o.object({error:o.string()}),Bi=o.union([Js,ts]),Ys=o.enum(["withdraw","deposit"]),Qs=o.object({id:o.string(),type:Ys,timestamp:o.string(),delta:o.object({usdAmount:Fe,token:o.object({caip19:o.string(),symbol:o.string(),image:o.string(),amount:Fe})})}),Ni=o.array(Qs),Xs=o.object({resting:o.object({oid:o.number()})}),Zs=o.object({filled:o.object({totalSz:N,avgPx:N,oid:o.number()})}),ei=o.object({error:o.string()}),ti=o.union([Xs,Zs,ei]),si=o.object({status:o.literal("ok"),response:o.object({type:o.literal("order"),data:o.object({statuses:o.array(ti)})})}),_i=o.union([si,ts]),ss=o.array(o.object({t:o.number(),T:o.number(),s:o.string(),i:o.string(),o:N,h:N,l:N,c:N,v:N,n:o.number()}));h();l();var ii=o.object({accountValue:B,availableBalance:B,availableToTrade:B}),is=o.object({accountValue:B,availableBalance:B,availableToTrade:B,dexAbstraction:o.boolean().optional(),dexs:o.record(o.string(),ii).optional()});h();l();var ri=o.enum(["withdrawal","deposit","reward"]),ni=o.object({id:o.string(),type:ri,timestamp:o.number(),usdcAmount:z}),rs=o.object({depositAndWithdrawals:o.array(o.any()).transform(i=>i.reduce((e,t)=>{let s=ni.safeParse(t);return s.success&&e.push(s.data),e},[]))});h();l();var tr=o.enum(["success","failed"]),sr=o.enum(["close","liquidation","take_profit","stop_loss"]),ir=o.literal("open"),ns=o.object({id:o.string(),market:o.object({token:ye,logoUri:o.string(),szDecimals:o.number().optional()}),type:o.string(),timestamp:o.number(),price:B,size:z,tradeValue:B,fee:z,closedPnl:o.optional(z)}),os=o.object({tradeHistory:o.array(ns).transform(i=>i.reduce((e,t)=>{let s=ns.safeParse(t);return s.success&&e.push(s.data),e},[]))});h();l();var ds=o.enum(["long","short"]),Re=o.object({direction:ds,leverage:B,size:z,margin:B,entryPrice:B,fundingPayments:z,market:o.object({token:ye,logoUri:o.string()}),value:B,unrealizedPnl:o.object({amount:z,percentage:z}),liquidationPrice:z}),cs=o.object({positions:o.array(Re).transform(i=>i.reduce((e,t)=>{let s=Re.safeParse(t);return s.success&&e.push(s.data),e},[]))}),as=o.object({id:o.string(),market:o.object({token:ye,logoUri:o.string()}),isTrigger:o.boolean(),direction:ds,type:o.enum(["take_profit_market","stop_market","limit"]),reduceOnly:o.boolean(),triggerPrice:B,limitPrice:B,timestamp:B,size:z}),ps=o.object({positions:o.array(Re).transform(i=>i.reduce((e,t)=>{let s=Re.safeParse(t);return s.success&&e.push(s.data),e},[])),openOrders:o.array(as).transform(i=>i.reduce((e,t)=>{let s=as.safeParse(t);return s.success&&e.push(s.data),e},[]))});h();l();function v(i,e){return i+Math.random()*e}a(v,"getRetryDelayWithJitter");h();l();var oi=o.object({address:o.string(),registered:o.boolean()}),ai=o.object({code:o.string(),registered:o.boolean()}).optional(),hs=o.object({providerFee:o.string(),phantomFee:o.string(),referral:ai.optional(),builder:oi.optional()});h();l();var ls=o.object({depositAddress:o.object({address:o.string()}),requestId:o.string()}),di=o.object({destinationAmount:o.string().optional(),sourceTxHash:o.string().optional(),state:o.enum(["done","sourceTxDiscovered","waitForSrcTxFinalization","buildingDstTx","signTx","broadcastTx","waitForDstTxFinalization","readyForWithdrawQueue","queuedForWithdraw","failure","additionalChecks"]),opCreatedAt:o.string().optional(),operationId:o.string().optional(),protocolAddress:o.string().optional(),sourceAddress:o.string().optional(),destinationAddress:o.string().optional(),sourceChain:o.string().optional(),destinationChain:o.string().optional(),sourceAmount:o.string().optional(),destinationFeeAmount:o.string().optional(),sweepFeeAmount:o.string().optional(),stateStartedAt:o.string().optional(),stateUpdatedAt:o.string().optional(),stateNextAttemptAt:o.string().optional(),destinationTxHash:o.string().optional(),asset:o.string().optional()}),us=o.object({usdcPrice:o.string(),orderAssetId:o.number(),operations:o.array(di)}),gs=o.discriminatedUnion("status",[o.object({status:o.literal("ok"),response:o.object({type:o.string()})}),o.object({status:o.literal("err"),response:o.string()})]),ms=o.discriminatedUnion("status",[o.object({status:o.literal("ok"),response:o.object({type:o.string()})}),o.object({status:o.literal("err"),response:o.string()})]),fs=o.object({status:o.enum(["ok","err"])}),ys=o.object({name:o.string(),midPx:o.string()}),ci=o.object({unixTime:o.number(),value:o.string(),open:o.string(),high:o.string(),low:o.string(),close:o.string(),volume:o.string()}),br=o.object({history:o.array(ci)}),ws=o.object({role:o.enum(["missing","user"])}),Ss=o.object({fundingCaip19Address:yt,spotAssetId:o.number(),spotTokenId:o.string(),spotTokenName:o.string(),spotSzDecimals:o.number(),eta:o.string(),fee:o.string(),minimumAmount:o.string()}),Ts=o.object({tokens:o.array(_t)}),K;(function(i){i.Hyperunit="hyperunit",i.Relay="relay"})(K||(K={}));var Ps=o.object({providers:o.array(o.object({name:o.nativeEnum(K),max:o.number(),initializingCaip19Address:o.optional(yt)}))});var De=class{static{a(this,"PerpsClient")}async getSpotBridgeInitialize(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/bridge-initialize",{params:{...e,bridgeProvider:Vt(e.bridgeProvider.toString())}}),s=ls.safeParse(t.data);if(!s.success)throw new Error(`Failed to parse spot bridge initialize response: ${s.error}`);return s.data}async getOperations(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/bridge-operations",{params:e}),s=us.safeParse(t.data);if(!s.success)throw new Error(`Failed to parse operations response: ${s.error}`);return s.data}async getAccountBalance(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/perp/balance",{params:{user:b(e)}});if(!L(t))throw new Error("Failed to get account balance: response is not okay");let s=t.data,r=is.safeParse(s);if(!r.success)throw new Error("Failed to get account balance: schema validation failed");return r.data}async getUserFundingHistory(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/perp/deposits-and-withdrawals",{params:{user:b(e)}});if(!L(t))throw new Error("Failed to get deposits and withdrawals: response is not okay");let s=t.data,r=rs.safeParse(s);if(!r.success)throw new Error("Failed to get deposits and withdrawals: schema validation failed");return r.data.depositAndWithdrawals}async getPositions(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/perp/positions",{params:{user:b(e)}});if(!L(t))throw new Error("Failed to get positions: response is not okay");let s=t.data,r=cs.safeParse(s);if(!r.success)throw new Error("Failed to get positions: schema validation failed");return r.data.positions}async getPositionsAndOpenOrders(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/perp/positions-and-open-orders",{params:{user:b(e)}});if(!L(t))throw new Error("Failed to get positions: response is not okay");let s=t.data,r=ps.safeParse(s);if(!r.success)throw new Error("Failed to get positions: schema validation failed");return r.data}async getHistoricalOrders(e,t){let s={user:b(e)};t&&t.length>0&&(s.markets=t.join(","));let r=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/perp/trade-history",{params:s});if(!L(r))throw new Error("Failed to get historical orders: response is not okay");let n=r.data,d=os.safeParse(n);if(!d.success)throw new Error("Failed to get historical orders: schema validation failed");return d.data.tradeHistory}async postSpotSend(e){let t=await F.api().retry(1,v(1e3,1e3)).post("/swap/v2/spot/send",e);if(!L(t))throw new Error("Failed to post spot send: response is not okay");let s=t.data,r=gs.safeParse(s);if(!r.success)throw new Error("Failed to post spot send: schema validation failed");return r.data}async postPerpsSend(e){let t=await F.api().retry(1,v(1e3,1e3)).post("/swap/v2/perps/send",e);if(!L(t))throw new Error("Failed to post perps send: response is not okay");let s=t.data,r=ms.safeParse(s);if(!r.success)throw new Error("Failed to post perps send: schema validation failed");return r.data}async postTransferUsdcSpotPerp(e){let t=await F.api().retry(1,v(1e3,1e3)).post("/swap/v2/transfer-usdc-spot-perp",e);if(!L(t))throw new Error("Failed to post spot send: response is not okay");let s=t.data,r=fs.safeParse(s);if(!r.success)throw new Error("Failed to post spot send: schema validation failed");return r.data}async getTokenDetails(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/token-details",{params:{tokenId:e.tokenId,type:"tokenDetails"}});if(!L(t))throw new Error("Failed to get token info: response is not okay");let s=t.data,r=ys.safeParse(s);if(!r.success)throw new Error("Failed to get token info: schema validation failed");return r.data}async getUserRole(e){let t=await fetch("https://api.hyperliquid.xyz/info",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({type:"userRole",user:e})});if(!t.ok)throw new Error("Failed to get token info");let s=await t.json(),r=ws.safeParse(s);if(!r.success)throw new Error("Failed to get user role: schema validation failed");return r.data}async postFunding(e){let t=await F.api().retry(1,v(1e3,1e3)).post("/swap/v2/spot/funding",e);if(!L(t))throw new Error("Failed to get funding");let s=t.data,r=Ss.safeParse(s);if(!r.success)throw new Error("Failed to post funding: schema validation failed");return r.data}async getPriceHistory(e){let t={coin:e.coin,interval:e.interval,startTime:e.startTime.toString(),endTime:e.endTime.toString()};e.isTestnet&&(t.isTestnet="true");let s=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/candles",{params:t});if(!L(s))throw new Error("Failed to get price history: response is not okay");let r=s.data,n=ss.safeParse(r);if(!n.success)throw new Error("Failed to get price history: schema validation failed");return n.data}async getSpotBalances(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/balances",{params:e});if(!L(t))throw new Error("Failed to get spot balances: response is not okay");return t.data}async getPositionFees(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/perp/fees",{params:{user:b(e)}});if(!L(t))throw new Error("Failed to get position fees: response is not okay");let s=t.data,r=hs.safeParse(s);if(!r.success)throw new Error("Failed to get position fees: schema validation failed");return r.data}async getBridgeableTokens(e){if(!e)throw new Error("No addresses provided to get bridgeable tokens");let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/bridgeable-tokens",{params:{addresses:e.join(",")}});if(!L(t))throw new Error("Failed to get bridgeable tokens: response is not okay");let s=t.data,r=Ts.safeParse(s);if(!r.success)throw new Error("Failed to get bridgeable tokens: schema validation failed");return r.data}async getPreferredBridges(){let e=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/preferred-bridges");if(!L(e))throw new Error("Failed to get preferred bridge: response is not okay");let t=e.data,s=Ps.safeParse(t);if(!s.success)throw new Error("Failed to get preferred bridge: schema validation failed");return s.data}};h();l();h();l();var x=[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}];var ve=[{name:"hyperliquidChain",type:"string"},{name:"maxFeeRate",type:"string"},{name:"builder",type:"address"},{name:"nonce",type:"uint64"}],j=[{name:"source",type:"string"},{name:"connectionId",type:"bytes32"}];h();l();var pi=o.object({totalSz:o.string(),avgPx:o.string(),oid:o.number()}),hi=o.object({oid:o.number()}),li=o.union([o.object({error:o.string()}),o.object({filled:pi}),o.literal("success"),o.object({resting:hi})]),ui=o.object({status:o.literal("ok"),response:o.object({type:o.string(),data:o.object({statuses:o.array(li)}).optional()})}),gi=o.union([o.object({status:o.literal("err"),response:o.string()}),ui]),Vr=o.object({action:o.any(),nonce:o.number(),signature:o.object({r:o.string(),s:o.string(),v:o.number()}),isTestnet:o.boolean().optional()});var re=class{static{a(this,"HyperliquidExchange")}async postExchange(e){return await m.startSpan("hyperliquid.exchange.post",async()=>{let s=(await F.api().post("/swap/v2/exchange",e)).data,r=gi.safeParse(s);if(!r.success)throw new Error(`Invalid exchange response: ${r.error.message}`);return r.data})}};h();l();function wt(i){return i.map(e=>({time:e.t/1e3,open:Number(e.o),high:Number(e.h),low:Number(e.l),close:Number(e.c),volume:Number(e.v)}))}a(wt,"mapRawCandleSnapshotToCandleSnapshot");h();l();var xe=class{static{a(this,"AccountBalanceStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingAccountBalanceStart":switch(this.state.type){case"accountBalance":return{type:"refreshing",accountBalance:this.state.accountBalance};case"refreshing":return{type:"refreshing",accountBalance:this.state.accountBalance};case"indeterminate":return{type:"loading",consecutiveErrors:0};case"error":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};case"loading":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};default:{let t=this.state;throw new Error(`Invalid state ${t.type} for fetchingAccountBalanceStart`)}}case"fetchingAccountBalanceSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"accountBalance",accountBalance:e.accountBalance};default:throw new Error(`Invalid state ${this.state.type} for fetchingAccountBalanceSuccess`)}case"fetchingAccountBalanceError":return{type:"error",error:e.error,consecutiveErrors:("consecutiveErrors"in this.state?this.state.consecutiveErrors:0)+1}}}getState(){return this.state}reset(){this.state={type:"indeterminate"},this.notifyListeners()}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onAccountBalanceStateChange(this.state)})}};h();l();var Me=class{static{a(this,"FundingHistoryStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingFundingHistoryStart":switch(this.state.type){case"history":return{type:"refreshing",history:this.state.history};case"refreshing":return{type:"refreshing",history:this.state.history};case"indeterminate":case"error":return{type:"loading"};default:throw new Error(`Invalid state ${this.state.type} for fetchingFundingHistoryStart`)}case"fetchingFundingHistorySuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"history",history:e.history};default:throw new Error(`Invalid state ${this.state.type} for fetchingFundingHistorySuccess`)}case"fetchingFundingHistoryError":switch(this.state.type){case"history":case"refreshing":return{type:"history",history:this.state.history};default:return{type:"error",error:e.error}}}}getState(){return this.state}reset(){this.state={type:"indeterminate"},this.notifyListeners()}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onFundingHistoryStateChange(this.state)})}};h();l();var Le=class{static{a(this,"HistoricalOrdersStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingHistoricalOrdersStart":switch(this.state.type){case"historicalOrders":return{type:"refreshing",historicalOrders:this.state.historicalOrders};case"refreshing":return{type:"refreshing",historicalOrders:this.state.historicalOrders};case"indeterminate":case"error":return{type:"loading"};default:throw new Error(`Invalid state ${this.state.type} for fetchingHistoricalOrdersStart`)}case"fetchingHistoricalOrdersSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"historicalOrders",historicalOrders:e.historicalOrders};default:throw new Error(`Invalid state ${this.state.type} for fetchingHistoricalOrdersSuccess`)}case"fetchingHistoricalOrdersError":return{type:"error",error:e.error}}}getState(){return this.state}reset(){this.state={type:"indeterminate"},this.notifyListeners()}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onHistoricalOrdersStateChange(this.state)})}};h();l();var Oe=class{static{a(this,"PositionsStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingPositionsStart":switch(this.state.type){case"positions":return{type:"refreshing",positions:this.state.positions,openOrders:this.state.openOrders};case"refreshing":return{type:"refreshing",positions:this.state.positions,openOrders:this.state.openOrders};case"indeterminate":return{type:"loading",consecutiveErrors:0};case"error":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};case"loading":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};default:{let t=this.state;throw new Error(`Invalid state ${t.type} for fetchingPositionsStart`)}}case"fetchingPositionsSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"positions",positions:e.positions,openOrders:e.openOrders};default:throw new Error(`Invalid state ${this.state.type} for fetchingPositionsSuccess`)}case"fetchingPositionsError":return{type:"error",error:e.error,consecutiveErrors:("consecutiveErrors"in this.state?this.state.consecutiveErrors:0)+1}}}getState(){return this.state}reset(){this.state={type:"indeterminate"},this.notifyListeners()}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onPositionStateChange(this.state)})}};h();l();h();l();var As=q(fe()),bs=q(ge());var Be=class{static{a(this,"UpdateIsolatedMarginAction")}type="updateIsolatedMargin";asset;isBuy;ntli;constructor(e){this.asset=e.asset,this.isBuy=e.isBuy,this.ntli=e.ntli}hash(e,t){let s=(0,As.encode)(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let d=new DataView(n.buffer,n.byteOffset,n.byteLength);return d.setBigUint64(s.length,BigInt(t)),e===null?d.setUint8(s.length+8,0):(d.setUint8(s.length+8,1),n.set(mi(e),s.length+9)),`0x${(0,bs.keccak256)(n)}`}};function mi(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(mi,"addressToBytes");h();l();function St(i){switch(i.type){case"preparingTransaction":case"managingMargin":case"manageMarginSucceeded":return Is(i);case"manageMarginFailed":return{...Is(i),error:i.error instanceof Error?i.error.message:"Unknown error"};case"indeterminate":default:return{state:i.type}}}a(St,"getManageMarginStateLogsDetails");var Is=a(i=>i.type==="indeterminate"?{state:i.type}:{marketSymbol:i.market.symbol,assetId:i.market.assetId.toString(),positionDirection:i.position.direction,positionSize:i.position.size.toString(),currentMargin:i.position.margin.toString(),marginDelta:i.marginDelta.toString(),marginAction:i.marginDelta.isPositive()?"increase":"decrease",newMargin:new g(i.position.margin).plus(i.marginDelta).toString(),fee:i.fee?.toString()||"N/A"},"getBaseLogsDetails");h();l();var Ne=class{static{a(this,"ManageMarginStateMachine")}listeners=[];state={type:"indeterminate"};getState(){return this.state}send(e){try{let t=this.determineNextState(this.state,e);this.state=t,this.notifyListeners(e)}catch(t){console.error("Error processing event in ManageMarginStateMachine:",e,t)}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}determineNextState(e,t){switch(t.type){case"InitiateManageMargin":{let{position:s,market:r,marginDelta:n,fee:d}=t.payload;return{type:"preparingTransaction",...{position:s,market:r,marginDelta:n,fee:d}}}case"ManageMarginInitiated":{if(e.type==="preparingTransaction")return{type:"managingMargin",position:e.position,market:e.market,marginDelta:e.marginDelta,fee:e.fee};break}case"ManageMarginSuccess":{if(e.type==="managingMargin")return{type:"manageMarginSucceeded",position:e.position,market:e.market,marginDelta:e.marginDelta,fee:e.fee};break}case"ManageMarginFailure":{if(e.type==="managingMargin")return{type:"manageMarginFailed",position:e.position,market:e.market,marginDelta:e.marginDelta,fee:e.fee,error:t.error};break}case"Reset":return{type:"indeterminate"}}return e}notifyListeners(e){this.listeners.forEach(t=>{t.onManageMarginStateChange(e,this.state)})}};var fi=6,_e=class{static{a(this,"ManageMarginOrchestrator")}stateMachine=new Ne;perps;constructor(e){this.perps=e,this.stateMachine.addListener(this.stateListener),this.stateMachine.addListener(this.stateLogsListener)}stateListener={onManageMarginStateChange:a((e,t)=>{this.handleStateChange(e,t)},"onManageMarginStateChange")};stateLogsListener={onManageMarginStateChange:a((e,t)=>{switch(t.type){case"manageMarginSucceeded":m.addBreadcrumb(f.Perps,`Manage margin succeeded: ${t.type}`,w.Info,St(t));break;case"manageMarginFailed":m.addBreadcrumb(f.Perps,`Manage margin failed: ${t.type}`,w.Error,St(t));break;default:m.addBreadcrumb(f.Perps,`Manage margin state change: ${e.type} -> ${t.type}`,w.Info);break}(t.type==="manageMarginSucceeded"||t.type==="manageMarginFailed")&&this.stateMachine.removeListener(this.stateLogsListener)},"onManageMarginStateChange")};async handleStateChange(e,t){switch(e.type){case"InitiateManageMargin":this.stateMachine.send({type:"ManageMarginInitiated"});break;case"ManageMarginInitiated":t.type==="managingMargin"&&await this.manageMargin(t);break}}async manageMargin(e){try{let{position:t,market:s,marginDelta:r}=e,n=r.multipliedBy(new g(10).pow(fi)).toNumber(),d=new Be({asset:s.assetId,isBuy:t.direction==="long",ntli:n}),p=Date.now(),c={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:d.hash(null,p)}},u=await this.perps.exchangeAction(d,c,p),S=u.response.data?.statuses?.find(T=>typeof T=="object"&&"error"in T);if(S&&typeof S=="object"&&"error"in S)throw new Error(S.error);let P=JSON.stringify(u.response.data?.statuses||"unknown");this.stateMachine.send({type:"ManageMarginSuccess",payload:P})}catch(t){this.stateMachine.send({type:"ManageMarginFailure",error:t})}}getState(){return this.stateMachine.getState()}send(e){this.stateMachine.send(e)}addListener(e){return this.stateMachine.addListener(e),()=>this.stateMachine.removeListener(e)}removeListener(e){this.stateMachine.removeListener(e)}};h();l();h();l();var Es=q(fe()),Cs=q(ge());var X=class{static{a(this,"OrderAction")}type="order";orders;grouping;builder;constructor(e,t){this.orders=e,this.grouping="na",t&&(this.builder=t)}hash(e,t){let s=(0,Es.encode)(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let d=new DataView(n.buffer,n.byteOffset,n.byteLength);return d.setBigUint64(s.length,BigInt(t)),e===null?d.setUint8(s.length+8,0):(d.setUint8(s.length+8,1),n.set(yi(e),s.length+9)),`0x${(0,Cs.keccak256)(n)}`}};function yi(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(yi,"addressToBytes");var Ue=class{static{a(this,"SpotSendAction")}hyperliquidChain;signatureChainId;amount;destination;time;token;type="spotSend";constructor(e){this.hyperliquidChain=e.hyperliquidChain,this.signatureChainId=e.signatureChainId,this.token=e.token,this.amount=e.amount,this.destination=e.destination,this.time=e.time}},qe=class{static{a(this,"PerpsSendAction")}hyperliquidChain;signatureChainId;amount;destination;time;type="usdSend";constructor(e){this.hyperliquidChain=e.hyperliquidChain,this.signatureChainId=e.signatureChainId,this.amount=e.amount,this.destination=e.destination,this.time=e.time}};h();l();var ks=q(fe()),Fs=q(ge());var ce=class{static{a(this,"ApproveReferralAction")}type="setReferrer";code;constructor(e){this.code=e.code}hash(e,t){let s=(0,ks.encode)(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let d=new DataView(n.buffer,n.byteOffset,n.byteLength);return d.setBigUint64(s.length,BigInt(t)),e===null?d.setUint8(s.length+8,0):(d.setUint8(s.length+8,1),n.set(wi(e),s.length+9)),`0x${(0,Fs.keccak256)(n)}`}};function wi(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(wi,"addressToBytes");h();l();var W=class{static{a(this,"OrderBuilder")}_order={};asset(e){return this._order.a=e,this}isBuy(e){return this._order.b=e,this}buy(){return this.isBuy(!0)}sell(){return this.isBuy(!1)}price(e){return this._order.p=e.toString(),this}size(e){return this._order.s=e.toString(),this}reduceOnly(e){return this._order.r=e,this}clientOrderId(e){return this._order.c=e,this}limitOrder(e="Gtc"){return this._order.t={limit:{tif:e}},this}postOnly(){return this.limitOrder("Alo")}immediateOrCancel(){return this.limitOrder("Ioc")}triggerOrder(e,t=!0,s="sl"){return this._order.t={trigger:{isMarket:t,triggerPx:e.toString(),tpsl:s}},this}stopLoss(e,t=!0){return this.triggerOrder(e,t,"sl")}takeProfit(e,t=!0){return this.triggerOrder(e,t,"tp")}build(){if(this._order.a===void 0)throw new Error("Asset is required");if(this._order.b===void 0)throw new Error("Buy/sell direction is required");if(this._order.p===void 0)throw new Error("Price is required");if(this._order.s===void 0)throw new Error("Size is required");if(this._order.t===void 0)throw new Error("Order type is required");return this._order.r===void 0&&(this._order.r=!1),this._order}};h();l();function $(i,e,t=!0,s=g.ROUND_HALF_UP){let r=new g(i);if(r.isInteger())return r.toString();let n=Si(e,t);return r.precision(5,s).toFixed(n,s).replace(/\.?0+$/,"")}a($,"formatPrice");function Si(i,e=!0){return Math.max((e?6:8)-i,0)}a(Si,"maxAllowedDecimalsInPrice");h();l();function He(i,e,t=g.ROUND_HALF_UP){return new g(i).toFixed(e,t).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"")}a(He,"formatSize");h();l();var ze=class{static{a(this,"CancelOrderBuilder")}_order={};asset(e){return this._order.a=e,this}orderId(e){return this._order.o=e,this}build(){if(this._order.a===void 0)throw new Error("Asset is required");if(this._order.o===void 0)throw new Error("Order ID is required");return this._order}};h();l();var Rs=q(fe()),Ds=q(ge());var je=class{static{a(this,"CancelOrderAction")}type="cancel";cancels;constructor(e){this.cancels=e}hash(e,t){let s=(0,Rs.encode)(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let d=new DataView(n.buffer,n.byteOffset,n.byteLength);return d.setBigUint64(s.length,BigInt(t)),e===null?d.setUint8(s.length+8,0):(d.setUint8(s.length+8,1),n.set(Ti(e),s.length+9)),`0x${(0,Ds.keccak256)(n)}`}};function Ti(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(Ti,"addressToBytes");h();l();function Tt(i){switch(i.type){case"preparingTransaction":case"registeringBuilder":case"builderRegistered":case"registeringReferral":case"referralRegistered":case"managingPosition":case"managePositionSucceeded":return vs(i);case"builderRegistrationFailed":case"referralRegistrationFailed":case"managePositionFailed":return{...vs(i),error:i.error instanceof Error?i.error.message:"Unknown error"};case"indeterminate":default:return{state:i.type}}}a(Tt,"getManagePositionStateLogsDetails");var vs=a(i=>i.type==="indeterminate"?{state:i.type}:{marketSymbols:i.markets.map(e=>e.symbol).join(", "),assetIds:i.markets.map(e=>e.assetId.toString()).join(", "),positionDirections:i.positions.map(e=>e.direction).join(", "),positionSizes:i.positions.map(e=>e.size.toString()).join(", "),updateType:i.update.type,fees:i.fees.map(e=>e.toString()).join(", "),...i.update.type==="close"&&{closeSize:i.update.size.toString()},...i.update.type==="addAutoClose"&&{tpTriggerPrice:i.update.autoClose.tp?.triggerPrice.toString()||"N/A",slTriggerPrice:i.update.autoClose.sl?.triggerPrice.toString()||"N/A"},...i.update.type==="removeAutoClose"&&{tpOrderId:i.update.autoClose.tp?.orderId?.toString()||"N/A",slOrderId:i.update.autoClose.sl?.orderId?.toString()||"N/A"}},"getBaseLogsDetails");h();l();var We=class{static{a(this,"ManagePositionStateMachine")}listeners=[];state={type:"indeterminate"};getState(){return this.state}send(e){try{let t=this.determineNextState(this.state,e);this.state=t,this.notifyListeners(e)}catch(t){console.error("Error processing event in ManagePositionStateMachine:",e,t)}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}determineNextState(e,t){switch(t.type){case"InitiateManagePosition":{let{positions:s,update:r,markets:n,fees:d,autoClose:p}=t.payload;return{type:"preparingTransaction",...{positions:s,update:r,markets:n,fees:d,autoClose:p}}}case"RegisterBuilderCodeInitiated":{if(e.type==="preparingTransaction")return{type:"registeringBuilder",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":{if(e.type==="registeringBuilder")return{type:"builderRegistered",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterBuilderCodeFailure":{if(e.type==="registeringBuilder")return{type:"builderRegistrationFailed",positions:e.positions,update:e.update,error:t.error,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterReferralInitiated":{if(e.type==="builderRegistered")return{type:"registeringReferral",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterReferralNotRequired":case"RegisterReferralSuccess":{if(e.type==="registeringReferral")return{type:"referralRegistered",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterReferralFailure":{if(e.type==="registeringReferral")return{type:"referralRegistrationFailed",positions:e.positions,update:e.update,error:t.error,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"ManagePositionInitiated":{if(e.type==="preparingTransaction"||e.type==="referralRegistered")return{type:"managingPosition",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"ManagePositionSuccess":{if(e.type==="managingPosition")return{type:"managePositionSucceeded",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"ManagePositionFailure":{if(e.type==="managingPosition")return{type:"managePositionFailed",positions:e.positions,update:e.update,error:t.error,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"Reset":return{type:"indeterminate"}}return e}notifyListeners(e){this.listeners.forEach(t=>{t.onManagePositionStateChange(e,this.state)})}};var pe=.1,$e=class{static{a(this,"ManagePositionOrchestrator")}stateMachine=new We;perps;constructor(e){this.perps=e,this.stateMachine.addListener(this.stateListener),this.stateMachine.addListener(this.stateLogsListener)}stateListener={onManagePositionStateChange:a((e,t)=>{this.handleStateChange(e,t)},"onManagePositionStateChange")};stateLogsListener={onManagePositionStateChange:a((e,t)=>{switch(t.type){case"managePositionSucceeded":m.addBreadcrumb(f.Perps,`Manage position succeeded: ${t.type}`,w.Info,Tt(t));break;case"builderRegistrationFailed":case"referralRegistrationFailed":case"managePositionFailed":m.addBreadcrumb(f.Perps,`Manage position failed: ${t.type}`,w.Error,Tt(t));break;default:m.addBreadcrumb(f.Perps,`Manage position state change: ${e.type} -> ${t.type}`,w.Info);break}(t.type==="managePositionSucceeded"||t.type==="managePositionFailed")&&this.stateMachine.removeListener(this.stateLogsListener)},"onManagePositionStateChange")};async handleStateChange(e,t){switch(e.type){case"InitiateManagePosition":e.payload.update.type==="close"?this.stateMachine.send({type:"RegisterBuilderCodeInitiated"}):this.stateMachine.send({type:"ManagePositionInitiated"});break;case"RegisterBuilderCodeInitiated":t.type==="registeringBuilder"&&await this.registerBuilder();break;case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":t.type==="builderRegistered"&&this.stateMachine.send({type:"RegisterReferralInitiated"});break;case"RegisterReferralInitiated":t.type==="registeringReferral"&&await this.registerReferral();break;case"RegisterReferralNotRequired":case"RegisterReferralSuccess":t.type==="referralRegistered"&&this.stateMachine.send({type:"ManagePositionInitiated"});break;case"ManagePositionInitiated":t.type==="managingPosition"&&await this.managePosition(t);break}}getState(){return this.stateMachine.getState()}send(e){this.stateMachine.send(e)}addListener(e){this.stateMachine.addListener(e)}removeListener(e){this.stateMachine.removeListener(e)}async registerBuilder(){try{let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing"||!e.positionFees.builder)throw new Error("position fees not found");if(e.positionFees.builder.registered){this.stateMachine.send({type:"RegisterBuilderCodeNotRequired"});return}let t=e.positionFees.builder.address,s=`${Number(e.positionFees.phantomFee.toString())*100}%`,r=Date.now(),n={type:"approveBuilderFee",hyperliquidChain:this.perps.isTestnet?"Testnet":"Mainnet",signatureChainId:this.perps.isTestnet?"0x66eee":"0xa4b1",maxFeeRate:s,builder:t,nonce:r},d={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.perps.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:ApproveBuilderFee",types:{EIP712Domain:x,"HyperliquidTransaction:ApproveBuilderFee":ve},message:n},c=(await this.perps.exchangeAction(n,d,r)).response.data?.statuses?.find(u=>typeof u=="object"&&"error"in u);if(c&&typeof c=="object"&&"error"in c)throw new Error(c.error);this.stateMachine.send({type:"RegisterBuilderCodeSuccess"})}catch(e){this.stateMachine.send({type:"RegisterBuilderCodeFailure",error:e})}}async registerReferral(){try{if(this.perps.isTestnet){this.stateMachine.send({type:"RegisterReferralSuccess"});return}let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing")throw new Error("position fees not found");if(!e.positionFees.referral||e.positionFees.referral.registered){this.stateMachine.send({type:"RegisterReferralNotRequired"});return}let t=e.positionFees.referral.code,s=new ce({code:t}),r=Date.now(),n={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:s.hash(null,r)}},p=(await this.perps.exchangeAction(s,n,r)).response.data?.statuses?.find(c=>typeof c=="object"&&"error"in c);if(p&&typeof p=="object"&&"error"in p)throw new Error(p.error);this.stateMachine.send({type:"RegisterReferralSuccess"})}catch(e){this.stateMachine.send({type:"RegisterReferralFailure",error:e})}}async managePosition(e){try{let{positions:t,update:s,markets:r}=e,n="",p=t.map(c=>c.direction==="long").map(c=>c);if(s.type==="removeAutoClose"){let c=await this.removeOrders(r[0].assetId,[s.autoClose.tp?.orderId,s.autoClose.sl?.orderId].filter(Boolean));if(!c)throw new Error("Failed to cancel auto close orders");n=c}else if(s.type==="removeLimitOrder"){let c=await this.removeOrders(r[0].assetId,[s.limitOrder.orderId].filter(Boolean));if(!c)throw new Error("Failed to cancel auto close orders");n=c}else if(s.type==="removeAllOrders"){let c=await this.removeOrders(r[0].assetId,[...s.limitOrders.map(u=>u.orderId).filter(Boolean),...[s.autoClose.tp?.orderId,s.autoClose.sl?.orderId].filter(Boolean)]);if(!c)throw new Error("Failed to cancel auto close orders");n=c}else if(s.type==="close"||s.type==="closeAll")n=await this.closePositions(r.map(u=>u.assetId),s.size instanceof g?[s.size.abs().toString()]:s.size.map(u=>u.abs().toString()),p,r.map(u=>u.currentPrice.toString()),r.map(u=>u.szDecimals));else if(s.type==="addAutoClose"){let c={tp:s.autoClose.tp?.orderId,sl:s.autoClose.sl?.orderId},u=await this.createAutoClose(c,r[0].assetId,p[0],r[0].szDecimals,s.autoClose);if(!u)throw new Error("Failed to cancel auto close orders");n=u}this.stateMachine.send({type:"ManagePositionSuccess",payload:n})}catch(t){this.stateMachine.send({type:"ManagePositionFailure",error:t})}}async closePositions(e,t,s,r,n){let d=this.perps.getPositionFeesState();if(d.type!=="positionFees"&&d.type!=="refreshing"||!d.positionFees.builder)throw new Error("position fees not found");let p={b:d.positionFees.builder.address.toLowerCase(),f:Number(d.positionFees.phantomFee)*100*100*10},c=[];for(let I=0;I<e.length;I++){let H=$(new g(r[I]).multipliedBy(s[I]?1-pe:1+pe),n[I]),_=He(new g(t[I]),n[I]),J=new W().asset(e[I]).isBuy(!s[I]).price(H).size(_).reduceOnly(!0).immediateOrCancel().build();c.push(J)}let u=new X(c,p),S=Date.now(),P={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:u.hash(null,S)}},T=await this.perps.exchangeAction(u,P,S),A=T.response.data?.statuses.find(I=>I==="error"||I?.error);if(A){let I=typeof A=="string"?"Operation failed":A.error;throw new Error(I)}let k=T.response.data?.statuses.find(I=>I==="filled"||I?.filled);if(k&&typeof k=="object"&&k.filled)return JSON.stringify(T.response.data?.statuses);throw new Error("No filled status found")}async createAutoClose(e,t,s,r,n){let d=[e.tp,e.sl].filter(Boolean).filter(M=>M!==-1);if(d.length>0&&!await this.removeOrders(t,d))throw new Error("Failed to cancel auto close orders");let p=this.perps.getPositionFeesState();if(p.type!=="positionFees"&&p.type!=="refreshing"||!p.positionFees.builder)throw new Error("position fees not found");let c={b:p.positionFees.builder.address.toLowerCase(),f:Number(p.positionFees.phantomFee)*100*100*10},u="0",S;if(n?.tp){let M=$(new g(n.tp.triggerPrice).multipliedBy(s?1-pe:1+pe),r),Y=$(new g(n.tp.triggerPrice),r).toString();S=new W().asset(t).isBuy(!s).price(M).size(u).reduceOnly(!0).triggerOrder(Y,!0,"tp").build()}let P;if(n?.sl){let M=$(new g(n.sl.triggerPrice).multipliedBy(s?1-pe:1+pe),r),Y=$(new g(n.sl.triggerPrice),r).toString();P=new W().asset(t).isBuy(!s).price(M).size(u).reduceOnly(!0).triggerOrder(Y,!0,"sl").build()}let T=[S,P].filter(Boolean),A=new X(T,c),k=Date.now(),I={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:A.hash(null,k)}},H=await this.perps.exchangeAction(A,I,k),_=H.response.data?.statuses.find(M=>M==="error"||M?.error);if(_){let M=typeof _=="string"?"Operation failed":_.error;throw new Error(M)}let J=H.response.data?.statuses.find(M=>M==="resting"||M?.resting);if(J&&typeof J=="object"&&J.resting&&J.resting.oid)return JSON.stringify(H.response.data?.statuses);throw new Error("No order status found")}async removeOrders(e,t){let s=t.map(u=>new ze().asset(e).orderId(Number(u)).build()),r=new je(s),n=Date.now(),d={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:r.hash(null,n)}},p=await this.perps.exchangeAction(r,d,n),c=p.response.data?.statuses.find(u=>u==="error"||u?.error);if(c){let u=typeof c=="string"?"Operation failed":c.error;throw new Error(u)}if(p.response.data?.statuses&&p.response.data?.statuses.length>0&&p.response.data?.statuses.every(u=>u==="success"||u?.success))return JSON.stringify({orderIds:s});throw new Error("Cancel operation failed")}};h();l();h();l();var xs=q(fe()),Ms=q(ge());var Ge=class{static{a(this,"UpdateLeverageAction")}type="updateLeverage";asset;isCross;leverage;constructor(e){this.asset=e.asset,this.isCross=e.isCross,this.leverage=e.leverage}hash(e,t){let s=(0,xs.encode)(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let d=new DataView(n.buffer,n.byteOffset,n.byteLength);return d.setBigUint64(s.length,BigInt(t)),e===null?d.setUint8(s.length+8,0):(d.setUint8(s.length+8,1),n.set(Pi(e),s.length+9)),`0x${(0,Ms.keccak256)(n)}`}};function Pi(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(Pi,"addressToBytes");h();l();function Pt(i){switch(i.type){case"preparingTransaction":case"updatingLeverage":case"leverageUpdated":case"registeringBuilder":case"builderRegistered":case"registeringReferral":case"referralRegistered":case"creatingPosition":case"orderSucceeded":return Ls(i);case"leverageUpdateFailed":case"builderRegistrationFailed":case"referralRegistrationFailed":case"orderFailed":return{...Ls(i),error:i.error instanceof Error?i.error.message:"Unknown error"};case"indeterminate":default:return{state:i.type}}}a(Pt,"getOpenPositionStateLogsDetails");var Ls=a(i=>i.type==="indeterminate"?{state:i.type}:{marketSymbol:i.market.symbol,assetId:i.market.assetId.toString(),direction:i.direction,margin:i.margin.toString(),leverage:i.leverage.toString(),size:i.size.toString(),sizeInCoin:i.sizeInCoin.toString(),estimatedLiquidationPrice:i.estimatedLiquidationPrice?.toString()||"N/A",fee:i.fee?.toString()||"N/A",action:i.action},"getBaseLogsDetails");h();l();var Ke=class{static{a(this,"OpenPositionStateMachine")}listeners=[];state={type:"indeterminate"};getState(){return this.state}send(e){try{let t=this.determineNextState(this.state,e);this.state=t,this.notifyListeners(e)}catch(t){console.error("Error processing event in OpenPositionStateMachine:",e,t)}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}determineNextState(e,t){switch(t.type){case"InitiateOpenPosition":{let{market:s,direction:r,margin:n,leverage:d,autoClose:p,estimatedLiquidationPrice:c,fee:u,action:S,limitPrice:P}=t.payload,T=new g(n).multipliedBy(d),A=new g(s.currentPrice),k=A.isGreaterThan(0)?T.dividedBy(A):new g(0);return{type:"preparingTransaction",...{market:s,direction:r,margin:n,leverage:d,autoClose:p,size:T,sizeInCoin:k,estimatedLiquidationPrice:c,fee:u,action:S,limitPrice:P}}}case"InitiateUpdateLeverage":{if(e.type==="preparingTransaction")return e;break}case"UpdateLeverageInitiated":{if(e.type==="preparingTransaction")return{type:"updatingLeverage",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"UpdateLeverageSuccess":{if(e.type==="updatingLeverage")return{type:"leverageUpdated",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"UpdateLeverageFailure":{if(e.type==="updatingLeverage")return{type:"leverageUpdateFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,error:t.error,action:e.action,limitPrice:e.limitPrice};break}case"RegisterBuilderCodeInitiated":{if(e.type==="leverageUpdated")return{type:"registeringBuilder",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":{if(e.type==="registeringBuilder")return{type:"builderRegistered",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterBuilderCodeFailure":{if(e.type==="registeringBuilder")return{type:"builderRegistrationFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,error:t.error,action:e.action,limitPrice:e.limitPrice};break}case"RegisterReferralInitiated":{if(e.type==="builderRegistered")return{type:"registeringReferral",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterReferralNotRequired":case"RegisterReferralSuccess":{if(e.type==="registeringReferral")return{type:"referralRegistered",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterReferralFailure":{if(e.type==="registeringReferral")return{type:"referralRegistrationFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,error:t.error,action:e.action,limitPrice:e.limitPrice};break}case"PositionCreationInitiated":{if(e.type==="referralRegistered")return{type:"creatingPosition",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"PositionCreationSuccess":{if(e.type==="creatingPosition")return{type:"orderSucceeded",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"PositionCreationFailure":{if(e.type==="creatingPosition")return{type:"orderFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,error:t.error,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"Reset":return{type:"indeterminate"}}return e}notifyListeners(e){this.listeners.forEach(t=>{t.onOpenPositionStateChange(e,this.state)})}};var he=.1,Ve=class{static{a(this,"OpenPositionOrchestrator")}stateMachine=new Ke;perps;constructor(e){this.perps=e,this.stateMachine.addListener(this.stateListener),this.stateMachine.addListener(this.stateLogsListener)}stateListener={onOpenPositionStateChange:a((e,t)=>{this.handleStateChange(e,t)},"onOpenPositionStateChange")};stateLogsListener={onOpenPositionStateChange:a((e,t)=>{switch(t.type){case"orderSucceeded":m.addBreadcrumb(f.Perps,`Open position succeeded: ${t.type}`,w.Info,Pt(t));break;case"leverageUpdateFailed":case"builderRegistrationFailed":case"referralRegistrationFailed":case"orderFailed":m.addBreadcrumb(f.Perps,`Open position failed: ${t.type}`,w.Error,Pt(t));break;default:m.addBreadcrumb(f.Perps,`Open position state change: ${e.type} -> ${t.type}`,w.Info);break}(t.type==="orderSucceeded"||t.type==="orderFailed")&&this.stateMachine.removeListener(this.stateLogsListener)},"onOpenPositionStateChange")};async handleStateChange(e,t){switch(e.type){case"InitiateOpenPosition":this.stateMachine.send({type:"InitiateUpdateLeverage",payload:{isCross:!1,leverage:e.payload.leverage}});break;case"InitiateUpdateLeverage":this.stateMachine.send({type:"UpdateLeverageInitiated"});break;case"UpdateLeverageInitiated":t.type==="updatingLeverage"&&await this.updateLeverage(t);break;case"UpdateLeverageSuccess":t.type==="leverageUpdated"&&this.stateMachine.send({type:"RegisterBuilderCodeInitiated"});break;case"InitiateRegisterBuilder":this.stateMachine.send({type:"RegisterBuilderCodeInitiated"});break;case"RegisterBuilderCodeInitiated":t.type==="registeringBuilder"&&await this.registerBuilder();break;case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":t.type==="builderRegistered"&&this.stateMachine.send({type:"RegisterReferralInitiated"});break;case"InitiateRegisterReferral":this.stateMachine.send({type:"RegisterReferralInitiated"});break;case"RegisterReferralInitiated":t.type==="registeringReferral"&&await this.registerReferral();break;case"RegisterReferralNotRequired":case"RegisterReferralSuccess":t.type==="referralRegistered"&&this.stateMachine.send({type:"PositionCreationInitiated"});break;case"PositionCreationInitiated":t.type==="creatingPosition"&&await this.createPosition(t);break}}getState(){return this.stateMachine.getState()}send(e){this.stateMachine.send(e)}addListener(e){this.stateMachine.addListener(e)}removeListener(e){this.stateMachine.removeListener(e)}async updateLeverage(e){try{let t=e.market.assetId,s=new Ge({asset:t,isCross:!1,leverage:e.leverage.toNumber()}),r=Date.now(),n={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:s.hash(null,r)}},p=(await this.perps.exchangeAction(s,n,r)).response.data?.statuses?.find(c=>typeof c=="object"&&"error"in c);if(p&&typeof p=="object"&&"error"in p)throw new Error(p.error);this.stateMachine.send({type:"UpdateLeverageSuccess"})}catch(t){this.stateMachine.send({type:"UpdateLeverageFailure",error:t})}}async registerBuilder(){try{let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing"||!e.positionFees.builder)throw new Error("position fees not found");if(e.positionFees.builder.registered){this.stateMachine.send({type:"RegisterBuilderCodeNotRequired"});return}let t=e.positionFees.builder.address,s=`${Number(e.positionFees.phantomFee.toString())*100}%`,r=Date.now(),n={type:"approveBuilderFee",hyperliquidChain:this.perps.isTestnet?"Testnet":"Mainnet",signatureChainId:this.perps.isTestnet?"0x66eee":"0xa4b1",maxFeeRate:s,builder:t,nonce:r},d={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.perps.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:ApproveBuilderFee",types:{EIP712Domain:x,"HyperliquidTransaction:ApproveBuilderFee":ve},message:n},c=(await this.perps.exchangeAction(n,d,r)).response.data?.statuses?.find(u=>typeof u=="object"&&"error"in u);if(c&&typeof c=="object"&&"error"in c)throw new Error(c.error);this.stateMachine.send({type:"RegisterBuilderCodeSuccess"})}catch(e){this.stateMachine.send({type:"RegisterBuilderCodeFailure",error:e})}}async registerReferral(){try{if(this.perps.isTestnet){this.stateMachine.send({type:"RegisterReferralSuccess"});return}let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing")throw new Error("position fees not found");if(!e.positionFees.referral||e.positionFees.referral.registered){this.stateMachine.send({type:"RegisterReferralNotRequired"});return}let t=e.positionFees.referral.code,s=new ce({code:t}),r=Date.now(),n={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:s.hash(null,r)}},p=(await this.perps.exchangeAction(s,n,r)).response.data?.statuses?.find(c=>typeof c=="object"&&"error"in c);if(p&&typeof p=="object"&&"error"in p)throw new Error(p.error);this.stateMachine.send({type:"RegisterReferralSuccess"})}catch(e){this.stateMachine.send({type:"RegisterReferralFailure",error:e})}}async createPosition(e){try{let t=await this.createOrder(e.market.assetId,e.size.toString(),e.direction==="long",e.limitPrice?e.limitPrice.toString():e.market.currentPrice.toString(),e.market.szDecimals,e.autoClose,e.action==="reduce",e.limitPrice?"limit":"market");this.stateMachine.send({type:"PositionCreationSuccess",payload:t})}catch(t){this.stateMachine.send({type:"PositionCreationFailure",error:t})}}async createOrder(e,t,s,r,n,d,p,c="market"){let u=c==="limit"?$(new g(r),n):$(new g(r).multipliedBy(s?1+he:1-he),n),S=this.perps.getPositionFeesState();if(S.type!=="positionFees"&&S.type!=="refreshing"||!S.positionFees.builder)throw new Error("position fees not found");let P={b:S.positionFees.builder.address.toLowerCase(),f:Number(S.positionFees.phantomFee)*100*100*10},T=He(new g(t).dividedBy(new g(r)),n),A;c==="limit"?A=new W().asset(e).isBuy(s).price(u).size(T).reduceOnly(p??!1).limitOrder().build():A=new W().asset(e).isBuy(s).price(u).size(T).reduceOnly(p??!1).immediateOrCancel().build();let k;if(d?.tp?.dollar){let U=$(new g(d.tp.dollar),n).toString(),mt=$(new g(d.tp.dollar).multipliedBy(s?1+he:1-he),n);k=new W().asset(e).isBuy(!s).price(mt).size(T).reduceOnly(!0).triggerOrder(U,!0,"tp").build()}let I;if(d?.sl?.dollar){let U=$(new g(d.sl.dollar),n).toString(),mt=$(new g(d.sl.dollar).multipliedBy(s?1+he:1-he),n);I=new W().asset(e).isBuy(!s).price(mt).size(T).reduceOnly(!0).triggerOrder(U,!0,"sl").build()}let H=[A,k,I].filter(Boolean),_=new X(H,P),J=Date.now(),M={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:_.hash(null,J)}},Y=await this.perps.exchangeAction(_,M,J),D=Y.response.data?.statuses?.find(U=>typeof U=="object"&&"error"in U);if(D&&typeof D=="object"&&"error"in D)throw new Error(D.error);let ue=Y.response.data?.statuses.find(U=>typeof U=="object"&&"filled"in U),gt=Y.response.data?.statuses.find(U=>typeof U=="object"&&"resting"in U);if(ue&&typeof ue=="object"&&"filled"in ue||gt)return JSON.stringify(Y.response.data?.statuses);throw new Error("No filled status found")}};h();l();var Je=class{static{a(this,"PositionFeesStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingPositionFeesStart":switch(this.state.type){case"positionFees":return{type:"refreshing",positionFees:this.state.positionFees};case"refreshing":return{type:"refreshing",positionFees:this.state.positionFees};case"indeterminate":case"error":return{type:"loading"};default:throw new Error(`Invalid state ${this.state.type} for fetchingPositionFeesStart`)}case"fetchingPositionFeesSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"positionFees",positionFees:e.fees};default:throw new Error(`Invalid state ${this.state.type} for fetchingPositionFeesSuccess`)}case"fetchingPositionFeesError":return{type:"error",error:e.error}}}getState(){return this.state}reset(){this.state={type:"indeterminate"},this.notifyListeners()}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onPositionFeesStateChange(this.state)})}};h();l();var At=["1H","1D","1W","1M","YTD","ALL"],Ye=class{static{a(this,"PricingStateMachine")}listeners=[];state={type:"indeterminate"};nextRequestId=1;send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"initiateSequentialFetch":{let t={"1H":{type:"idle"},"1D":{type:"idle"},"1W":{type:"idle"},"1M":{type:"idle"},YTD:{type:"idle"},ALL:{type:"idle"}};return{type:"multiInterval",activeCoin:e.coin,requestId:this.nextRequestId++,intervals:t,currentlyFetchingInterval:null,sequenceComplete:!1}}case"fetchingIntervalStart":return this.state.type!=="multiInterval"?this.state:e.requestId!==this.state.requestId||e.coin!==this.state.activeCoin?this.state:{...this.state,intervals:{...this.state.intervals,[e.interval]:{type:"loading"}},currentlyFetchingInterval:e.interval};case"fetchingIntervalSuccess":{if(this.state.type!=="multiInterval")return this.state;if(e.requestId!==this.state.requestId||e.coin!==this.state.activeCoin)return this.state;let t={...this.state.intervals,[e.interval]:{type:"loaded",candleSnapshots:e.candleSnapshots}},s=At.every(r=>{let n=t[r];return n.type==="loaded"||n.type==="error"});return{type:"multiInterval",activeCoin:this.state.activeCoin,requestId:this.state.requestId,intervals:t,currentlyFetchingInterval:null,sequenceComplete:s}}case"fetchingIntervalError":{if(this.state.type!=="multiInterval")return this.state;if(e.requestId!==this.state.requestId||e.coin!==this.state.activeCoin)return this.state;let t={...this.state.intervals,[e.interval]:{type:"error",error:e.error}},s=At.every(r=>{let n=t[r];return n.type==="loaded"||n.type==="error"});return{type:"multiInterval",activeCoin:this.state.activeCoin,requestId:this.state.requestId,intervals:t,currentlyFetchingInterval:null,sequenceComplete:s}}case"sequentialFetchComplete":return this.state.type!=="multiInterval"?this.state:{...this.state,sequenceComplete:!0};default:return this.state}}getState(){return this.state}getNextIntervalToFetch(){if(this.state.type!=="multiInterval")return null;for(let e of At)if(this.state.intervals[e].type==="idle")return e;return null}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onPricingStateChange(this.state)})}};h();l();var Qe=.98,Xe=class{static{a(this,"Spot")}perps;perpsClient;constructor(e,t){this.perps=e,this.perpsClient=t}async getSpotBalances(e){let t=b({address:e,chainId:me.Mainnet,resourceType:O.address});return(await this.perpsClient.getSpotBalances({user:t})).balances}async buy(e,t,s){let r=new g(s).dividedBy(Qe).decimalPlaces(2);return this.placeBuySellOrder(e,t,!0,r.toString())}async sell(e,t,s){let r=new g(s).multipliedBy(Qe).decimalPlaces(2);return this.placeBuySellOrder(e,t,!1,r.toString())}async placeBuySellOrder(e,t,s,r){if(!this.perps.user?.address)throw new Error("User not found");let d=new W().asset(e).isBuy(s).price(r).size(t).reduceOnly(!1).immediateOrCancel().build(),p=new X([d]),c=Date.now(),u={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:x,Agent:j},message:{source:this.perps.isTestnet?"b":"a",connectionId:p.hash(null,c)}},S=await this.perps.exchangeAction(p,u,c),P=S.response.data?.statuses.find(A=>typeof A=="object"&&"error"in A);if(P&&typeof P=="object"&&"error"in P)throw new Error(P.error);let T=S.response.data?.statuses.find(A=>typeof A=="object"&&"filled"in A);if(T&&typeof T=="object"&&"filled"in T)return{totalSz:T.filled.totalSz,avgPx:T.filled.avgPx};throw new Error("No filled status found")}async send(e,t,s,r){let n=`${e}:${t}`,d=Date.now(),p=new Ue({hyperliquidChain:this.perps.isTestnet?"Testnet":"Mainnet",signatureChainId:this.perps.isTestnet?"0x66eee":"0xa4b1",token:n,amount:s.toString(),destination:r.toLowerCase(),time:d}),c={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.perps.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:SpotSend",types:{EIP712Domain:x,"HyperliquidTransaction:SpotSend":[{name:"hyperliquidChain",type:"string"},{name:"destination",type:"string"},{name:"token",type:"string"},{name:"amount",type:"string"},{name:"time",type:"uint64"}]},message:p},{splitSignature:u}=await this.perps.sign(c),S=await this.perpsClient.postSpotSend({action:p,nonce:d,signature:u});if(S.status==="err")throw new Error(S.response);return S.response}async getTokenMidPrice(e){let t=await this.perpsClient.getTokenDetails({tokenId:e});return new g(t.midPx)}};var Ze=class{static{a(this,"Perps")}client;accountBalanceStateMachine=new xe;positionsStateMachine=new Oe;pricingStateMachine=new Ye;positionFeesStateMachine=new Je;signer=void 0;fundingHistoryStateMachine=new Me;historicalOrdersStateMachine=new Le;openPositionOrchestrator;managePositionOrchestrator;manageMarginOrchestrator;accountChangeListeners=[];account;user;isTestnet;spot;fundingPool;relayFundingTaskFactory;hyperunitFundingTaskFactory;sequentialPricingCoin=null;pricingRequestId=null;authRepository;constructor({client:e,isTestnet:t,fundingPool:s,relayFundingTaskFactory:r,hyperunitFundingTaskFactory:n,authRepository:d}){this.client=e,this.isTestnet=t,this.spot=new Xe(this,this.client),this.fundingPool=s,this.fundingPool.addListener(this.fundingPoolListener),this.relayFundingTaskFactory=r,this.hyperunitFundingTaskFactory=n,this.openPositionOrchestrator=new Ve(this),this.managePositionOrchestrator=new $e(this),this.manageMarginOrchestrator=new _e(this),this.authRepository=d,this.pricingStateMachine.addListener({onPricingStateChange:this.handlePricingStateChange.bind(this)}),this.accountBalanceStateMachine.addListener({onAccountBalanceStateChange:a(p=>{this.enableDexAbstraction(p)},"onAccountBalanceStateChange")})}setSigner(e){this.signer=e}createRelayFundingTask(e,t,s,r){return this.relayFundingTaskFactory.createTask(this,e,this.authRepository,t,s,te(this.signer),te(this.user),r)}createHyperunitFundingTask(e,t,s,r){return this.hyperunitFundingTaskFactory.createTask(this,e,this.authRepository,t,s,te(this.signer),te(this.user),r)}executeFundingTask(e,t,s,r,n){this.fundingPool.submit(e,t,s,r,n)}fundingPoolListener={onFundingPoolStateChange:a((e,t)=>{(e.type==="fundingCompleted"||e.type==="fundingStarted")&&(this.syncAccountBalance(),this.syncFundingHistory())},"onFundingPoolStateChange")};setAccount(e){this.resetAllState(),this.account=e;let{address:t}=e.addresses?.find(s=>ie.isEVMNetworkID(s.networkID))??{addressType:se.EVM,networkID:Nt.Ethereum.Mainnet};t&&(this.user={resourceType:O.address,chainId:this.isTestnet?"hypercore:testnet":ie.hypercore.mainnetID,address:t},this.fundingPool.setAccountId(t)),this.accountChangeListeners.forEach(s=>s.onAccountChange(e))}resetAllState(){this.accountBalanceStateMachine.reset(),this.positionsStateMachine.reset(),this.fundingHistoryStateMachine.reset(),this.historicalOrdersStateMachine.reset(),this.positionFeesStateMachine.reset()}getAccount(){return this.account}getUser(){return this.user}subscribeAccountChange(e){return this.accountChangeListeners.push(e),()=>this.unsubscribeAccountChange(e)}unsubscribeAccountChange(e){this.accountChangeListeners=this.accountChangeListeners.filter(t=>t!==e)}getAccountBalanceState(){return this.accountBalanceStateMachine.getState()}syncAccountBalance(){if(!this.user)return;let e=this.accountBalanceStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.accountBalanceStateMachine.send({type:"fetchingAccountBalanceStart"}),this.client.getAccountBalance(this.user).then(t=>{this.accountBalanceStateMachine.send({type:"fetchingAccountBalanceSuccess",accountBalance:t})}).catch(t=>{this.accountBalanceStateMachine.send({type:"fetchingAccountBalanceError",error:t}),m.addBreadcrumb(f.Perps,"Error fetching account balance",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribeAccountBalanceState(e){return this.accountBalanceStateMachine.addListener(e),()=>{this.unsubscribeAccountBalanceState(e)}}unsubscribeAccountBalanceState(e){this.accountBalanceStateMachine.removeListener(e)}getPositionFeesState(){return this.positionFeesStateMachine.getState()}syncPositionFees(){if(!this.user)return;let e=this.positionFeesStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.positionFeesStateMachine.send({type:"fetchingPositionFeesStart"}),this.client.getPositionFees(this.user).then(t=>{this.positionFeesStateMachine.send({type:"fetchingPositionFeesSuccess",fees:t})}).catch(t=>{this.positionFeesStateMachine.send({type:"fetchingPositionFeesError",error:t}),m.addBreadcrumb(f.Perps,"Error fetching position fees",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribePositionFees(e){return this.positionFeesStateMachine.addListener(e),()=>{this.unsubscribePositionFees(e)}}unsubscribePositionFees(e){this.positionFeesStateMachine.removeListener(e)}getPositionsState(){return this.positionsStateMachine.getState()}syncPositions(){if(!this.user)return;let e=this.positionsStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.positionsStateMachine.send({type:"fetchingPositionsStart"}),this.client.getPositionsAndOpenOrders(this.user).then(t=>{this.positionsStateMachine.send({type:"fetchingPositionsSuccess",positions:t.positions,openOrders:t.openOrders})}).catch(t=>{this.positionsStateMachine.send({type:"fetchingPositionsError",error:t}),m.addBreadcrumb(f.Perps,"Error fetching positions",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribePositions(e){return this.positionsStateMachine.addListener(e),()=>{this.unsubscribePositions(e)}}unsubscribePositions(e){this.positionsStateMachine.removeListener(e)}getFundingHistoryState(){return this.fundingHistoryStateMachine.getState()}syncFundingHistory(){if(!this.user)return;let e=this.fundingHistoryStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.fundingHistoryStateMachine.send({type:"fetchingFundingHistoryStart"}),this.client.getUserFundingHistory(this.user).then(t=>{this.fundingHistoryStateMachine.send({type:"fetchingFundingHistorySuccess",history:t})}).catch(t=>{this.fundingHistoryStateMachine.send({type:"fetchingFundingHistoryError",error:t}),m.addBreadcrumb(f.Perps,"Error fetching funding history",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribeFundingHistory(e){return this.fundingHistoryStateMachine.addListener(e),()=>{this.unsubscribeFundingHistory(e)}}unsubscribeFundingHistory(e){this.fundingHistoryStateMachine.removeListener(e)}getHistoricalOrdersState(){return this.historicalOrdersStateMachine.getState()}syncHistoricalOrders(e){if(!this.user)return;let t=this.historicalOrdersStateMachine.getState();t.type==="loading"||t.type==="refreshing"||(this.historicalOrdersStateMachine.send({type:"fetchingHistoricalOrdersStart"}),this.client.getHistoricalOrders(this.user,e).then(s=>{this.historicalOrdersStateMachine.send({type:"fetchingHistoricalOrdersSuccess",historicalOrders:s})}).catch(s=>{this.historicalOrdersStateMachine.send({type:"fetchingHistoricalOrdersError",error:s}),m.addBreadcrumb(f.Perps,"Error fetching historical orders",w.Error,{error:s instanceof Error?s.message:"Unknown error",markets:e?.join(",")??"No markets"})}))}subscribeHistoricalOrders(e){return this.historicalOrdersStateMachine.addListener(e),()=>{this.unsubscribeHistoricalOrders(e)}}unsubscribeHistoricalOrders(e){this.historicalOrdersStateMachine.removeListener(e)}getPricingState(){return this.pricingStateMachine.getState()}syncPricing(e,t,s,r){if(!this.user)return;let n;switch(t){case"1m":n="1H";break;case"15m":n="1D";break;case"1h":n="1W";break;case"4h":n="1M";break;case"1d":n="ALL";break;default:n="1D"}let d=this.pricingStateMachine.getState();(d.type!=="multiInterval"||d.activeCoin!==e)&&this.pricingStateMachine.send({type:"initiateSequentialFetch",coin:e});let p=this.pricingStateMachine.getState(),c=p.type==="multiInterval"?p.requestId:null;c!=null&&(this.pricingStateMachine.send({type:"fetchingIntervalStart",interval:n,coin:e,requestId:c,apiInterval:t,startTime:s,endTime:r}),this.client.getPriceHistory({coin:e,interval:n,startTime:s,endTime:r,isTestnet:this.isTestnet}).then(u=>{let S=wt(u);this.pricingStateMachine.send({type:"fetchingIntervalSuccess",interval:n,coin:e,requestId:c,candleSnapshots:S})}).catch(u=>{this.pricingStateMachine.send({type:"fetchingIntervalError",interval:n,coin:e,requestId:c,error:u}),m.addBreadcrumb(f.Perps,"Error fetching pricing",w.Error,{error:u instanceof Error?u.message:"Unknown error",coin:e,interval:t,startTime:s,endTime:r})}))}getTimeFrameDetails(e,t){let s=t,r,n;switch(e){case"1H":r=t-1e3*60*60*1,n="1m";break;case"1D":r=t-1e3*60*60*24,n="30m";break;case"1W":r=t-1e3*60*60*24*7,n="4h";break;case"1M":r=t-1e3*60*60*24*30,n="12h";break;case"YTD":r=new Date(new Date().getFullYear(),0,1).getTime(),n="1d";break;case"ALL":r=t-1e3*60*60*24*365*10,n="1d";break}return{startTime:r,endTime:s,apiInterval:n}}startSequentialPricingSync(e){this.sequentialPricingCoin=e,this.pricingStateMachine.send({type:"initiateSequentialFetch",coin:e});let t=this.pricingStateMachine.getState();this.pricingRequestId=t.type==="multiInterval"?t.requestId:null,this.fetchNextInterval()}fetchNextInterval(){let e=this.pricingStateMachine.getNextIntervalToFetch();if(!e||!this.sequentialPricingCoin)return;let t=this.pricingRequestId;if(t==null)return;let s=new Date().getTime(),{startTime:r,endTime:n,apiInterval:d}=this.getTimeFrameDetails(e,s);this.pricingStateMachine.send({type:"fetchingIntervalStart",interval:e,coin:this.sequentialPricingCoin,requestId:t,apiInterval:d,startTime:r,endTime:n}),this.client.getPriceHistory({coin:this.sequentialPricingCoin,interval:d,startTime:r,endTime:n,isTestnet:this.isTestnet}).then(p=>{let c=wt(p);this.pricingStateMachine.send({type:"fetchingIntervalSuccess",interval:e,coin:this.sequentialPricingCoin,requestId:t,candleSnapshots:c})}).catch(p=>{this.pricingStateMachine.send({type:"fetchingIntervalError",interval:e,coin:this.sequentialPricingCoin,requestId:t,error:p}),m.addBreadcrumb(f.Perps,"Error fetching next pricing interval",w.Error,{error:p instanceof Error?p.message:"Unknown error",coin:this.sequentialPricingCoin,interval:e,apiInterval:d,startTime:r,endTime:new Date(n).toISOString()})})}handlePricingStateChange(e){e.type==="multiInterval"&&!e.currentlyFetchingInterval&&!e.sequenceComplete&&setTimeout(()=>{this.fetchNextInterval()},100)}isEnablingDexAbstraction=!1;dexAbstractionRetryCount=0;async enableDexAbstraction(e){if(e.type==="accountBalance"){if(e.accountBalance.dexAbstraction){this.dexAbstractionRetryCount=0;return}if(new g(e.accountBalance.accountValue).gt(0)&&!(this.dexAbstractionRetryCount>=5)&&this.user&&!this.isEnablingDexAbstraction){this.isEnablingDexAbstraction=!0,this.dexAbstractionRetryCount++;try{await this.setUserDexAbstraction({enabled:!0}),m.addBreadcrumb(f.Perps,"DEX abstraction enabled",w.Info),this.dexAbstractionRetryCount=0}catch(t){m.addBreadcrumb(f.Perps,"Failed to enable DEX abstraction",w.Error,{error:t instanceof Error?t.message:"Unknown error",retryAttempt:this.dexAbstractionRetryCount})}finally{this.isEnablingDexAbstraction=!1}}}}subscribePricing(e){return this.pricingStateMachine.addListener(e),()=>{this.unsubscribePricing(e)}}unsubscribePricing(e){this.pricingStateMachine.removeListener(e)}async sign(e){let t=te(this.signer),s=te(this.account),{signature:r}=await t.sign(s.identifier,{chainType:se.EVM,signingType:"typedData",version:4,data:e});return{splitSignature:Os(r)}}async exchangeAction(e,t,s){let r=new re,n=te(this.signer),d=te(this.account),{signature:p}=await n.sign(d.identifier,{chainType:se.EVM,signingType:"typedData",version:4,data:t}),c=Os(p),u=await r.postExchange({action:e,nonce:s,signature:{r:c.r,s:c.s,v:c.v},isTestnet:this.isTestnet});if(u.status==="err")throw new Error(u.response);if(u.status==="ok")return u;throw new Error("Unknown response status")}async transfer(e){let{toPerp:t,amount:s}=e,r=Date.now(),n={type:"usdClassTransfer",hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",amount:s.toString(),toPerp:t,nonce:r},d={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:UsdClassTransfer",types:{EIP712Domain:x,"HyperliquidTransaction:UsdClassTransfer":[{name:"hyperliquidChain",type:"string"},{name:"amount",type:"string"},{name:"toPerp",type:"bool"},{name:"nonce",type:"uint64"}]},message:n},{splitSignature:p}=await this.sign(d),u=await new re().postExchange({action:n,nonce:r,signature:p,isTestnet:this.isTestnet});if(u.status==="err")throw new Error(u.response);return u}async sendAsset(e){let{destination:t,sourceDex:s,destinationDex:r,token:n,amount:d,vaultAddress:p}=e,c=Date.now(),u={type:"sendAsset",hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",destination:t.toLowerCase(),sourceDex:s,destinationDex:r,token:n,amount:d.toString(),fromSubAccount:p?p.toLowerCase():"",nonce:c},S={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:SendAsset",types:{EIP712Domain:x,"HyperliquidTransaction:SendAsset":[{name:"hyperliquidChain",type:"string"},{name:"destination",type:"string"},{name:"sourceDex",type:"string"},{name:"destinationDex",type:"string"},{name:"token",type:"string"},{name:"amount",type:"string"},{name:"fromSubAccount",type:"string"},{name:"nonce",type:"uint64"}]},message:u},{splitSignature:P}=await this.sign(S),A=await new re().postExchange({action:u,nonce:c,signature:P,isTestnet:this.isTestnet});if(A.status==="err")throw new Error(A.response);return A}async setUserDexAbstraction(e){let{enabled:t}=e;if(!this.user)throw new Error("User not set");let s=Date.now(),r={type:"userDexAbstraction",hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",user:this.user.address,enabled:t,nonce:s},n={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:UserDexAbstraction",types:{EIP712Domain:x,"HyperliquidTransaction:UserDexAbstraction":[{name:"hyperliquidChain",type:"string"},{name:"user",type:"address"},{name:"enabled",type:"bool"},{name:"nonce",type:"uint64"}]},message:r},{splitSignature:d}=await this.sign(n),c=await new re().postExchange({action:r,nonce:s,signature:d});if(c.status==="err")throw new Error(c.response);return c}async usdSendPerps(e){let{destination:t,amount:s}=e,r=Date.now(),n=new qe({hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",amount:s.toString(),destination:t.toLowerCase(),time:r}),d={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:UsdSend",types:{EIP712Domain:x,"HyperliquidTransaction:UsdSend":[{name:"hyperliquidChain",type:"string"},{name:"destination",type:"string"},{name:"amount",type:"string"},{name:"time",type:"uint64"}]},message:n},{splitSignature:p}=await this.sign(d),c=await this.client.postPerpsSend({action:n,nonce:r,signature:p});if(c.status==="err")throw new Error(c.response);return c.response}openPosition(e){this.openPositionOrchestrator.send({type:"InitiateOpenPosition",payload:e})}resetOpenPosition(){this.openPositionOrchestrator.send({type:"Reset"})}getOpenPositionState(){return this.openPositionOrchestrator.getState()}subscribeOpenPosition(e){return this.openPositionOrchestrator.addListener(e),()=>{this.unsubscribeOpenPosition(e)}}unsubscribeOpenPosition(e){this.openPositionOrchestrator.removeListener(e)}managePosition(e){this.managePositionOrchestrator.send({type:"InitiateManagePosition",payload:e})}resetManagePosition(){this.managePositionOrchestrator.send({type:"Reset"})}getManagePositionState(){return this.managePositionOrchestrator.getState()}subscribeManagePosition(e){return this.managePositionOrchestrator.addListener(e),()=>{this.unsubscribeManagePosition(e)}}unsubscribeManagePosition(e){this.managePositionOrchestrator.removeListener(e)}manageMargin(e){this.manageMarginOrchestrator.send({type:"InitiateManageMargin",payload:e})}resetManageMargin(){this.manageMarginOrchestrator.send({type:"Reset"})}getManageMarginState(){return this.manageMarginOrchestrator.getState()}subscribeManageMargin(e){return this.manageMarginOrchestrator.addListener(e)}};function te(i,e){if(i==null)throw new Error(e||"Required value is undefined or null");return i}a(te,"check");function Os(i){let e=`0x${i.slice(2,66)}`,t=`0x${i.slice(66,130)}`,s=parseInt(i.slice(130,132),16);return{r:e,s:t,v:s}}a(Os,"splitSignature");h();l();var ne=q(ft());var E;(function(i){i.FUNDING_INITIALIZED="perpsDepositInitialized",i.FUNDING_INITIATED="perpsDepositInitiated",i.FUNDING_COMPLETED="perpsDepositCompleted",i.FUNDING_FAILED="perpsDepositFailed",i.FUNDING_PAUSED="perpsDepositPaused",i.FUNDING_RESUMED="perpsDepositResumed",i.DEPOSIT_TRANSFER_STARTED="perpsHyperunitDepositTransferStarted",i.DEPOSIT_TRANSFER_COMPLETED="perpsHyperunitDepositTransferCompleted",i.DEPOSIT_STREAM_OPERATIONS_STARTED="perpsHyperunitDepositStreamOperationsStarted",i.DEPOSIT_STREAM_OPERATIONS_COMPLETED="perpsHyperunitDepositStreamOperationsCompleted",i.DEPOSIT_SELL_SPOT_STARTED="perpsHyperunitDepositSellSpotStarted",i.DEPOSIT_SELL_SPOT_COMPLETED="perpsHyperunitDepositSellSpotCompleted",i.DEPOSIT_TRANSFER_TO_PERP_STARTED="perpsHyperunitDepositTransferToPerpStarted",i.DEPOSIT_TRANSFER_TO_PERP_COMPLETED="perpsHyperunitDepositTransferToPerpCompleted"})(E||(E={}));var C;(function(i){i.FUNDING_INITIALIZED="perpsWithdrawInitialized",i.FUNDING_COMPLETED="perpsWithdrawCompleted",i.FUNDING_FAILED="perpsWithdrawFailed",i.FUNDING_PAUSED="perpsWithdrawPaused",i.FUNDING_RESUMED="perpsWithdrawResumed",i.PERPS_TO_SPOT_STARTED="perpsHyperunitWithdrawPerpsToSpotStarted",i.PERPS_TO_SPOT_COMPLETED="perpsHyperunitWithdrawPerpsToSpotCompleted",i.BUY_ASSET_STARTED="perpsHyperunitWithdrawBuyAssetStarted",i.BUY_ASSET_COMPLETED="perpsHyperunitWithdrawBuyAssetCompleted",i.SEND_TO_WITHDRAW_ADDRESS_STARTED="perpsHyperunitWithdrawSendToWithdrawAddressStarted",i.SEND_TO_WITHDRAW_ADDRESS_COMPLETED="perpsHyperunitWithdrawSendToWithdrawAddressCompleted",i.WITHDRAW_STREAM_OPERATIONS_STARTED="perpsHyperunitWithdrawStreamOperationsStarted",i.WITHDRAW_STREAM_OPERATIONS_COMPLETED="perpsHyperunitWithdrawStreamOperationsCompleted"})(C||(C={}));var Bs;(function(i){i.INITIALIZED="perpsFundingInitialized",i.INITIALIZATION_ERROR="perpsFundingInitializationError",i.BELOW_MINIMUM_INPUT_AMOUNT="perpsFundingBelowMinimumInputAmount",i.INSUFFICIENT_BALANCE="perpsFundingInsufficientBalance",i.EXCEEDS_MAXIMUM_LIMIT="perpsFundingExceedsMaximumLimit",i.FUNDABLE="perpsFundingFundable"})(Bs||(Bs={}));var Ns=a(()=>{let i=$t(),e=(0,ne.useCallback)((n,d)=>{i.capture(n,{data:{...d}}),n===E.FUNDING_FAILED&&m.captureError(new Error(`depositFailed: ${d.error}`),f.Perps),n===C.FUNDING_FAILED&&m.captureError(new Error(`withdrawalFailed: ${d.error}`),f.Perps)},[i]),t=(0,ne.useCallback)((n,d)=>{e(n,d)},[e]),s=(0,ne.useCallback)((n,d)=>{e(n,d)},[e]),r=(0,ne.useCallback)((n,d)=>{e(n,d)},[e]);return(0,ne.useMemo)(()=>({reportDeposit:t,reportWithdraw:s,reportFundingUIState:r}),[t,s,r])},"useFundingAnalytics");h();l();var et=class{static{a(this,"FundingStateLogsListener")}onFundingPoolStateChange(e,t,s){switch(e.type){case"fundingFailed":m.addBreadcrumb(f.Perps,`FundingPool: ${t.type} funding failed`,w.Error,{error:e.error.message,fundingTaskState:t.getState().type});break;case"fundingStarted":case"fundingBridgingStarted":case"fundingCompleted":m.addBreadcrumb(f.Perps,`FundingPool: ${t.type} ${e.type}`,w.Info);break}}};h();l();var tt=class{static{a(this,"FundingToastListener")}onFundingPoolStateChange(e,t,s){switch(t.type){case"deposit":this.onDepositEvent(e,t);break;case"withdraw":this.onWithdrawEvent(e,t);break}}onDepositEvent(e,t){if(!t.silentToasts)switch(e.type){case"fundingStarted":this.progress(Q.t("perpsToastInitiatingFunding"));break;case"fundingBridgingStarted":break;case"fundingCompleted":this.success(Q.t("perpsToastFundsAdded"));break;case"fundingFailed":this.failed(Q.t("perpsToastFundingFailed"),e.error.message,Q.t("commandOK"),()=>{ee.getState().hideToast()});break}}onWithdrawEvent(e,t){switch(e.type){case"fundingStarted":this.progress(Q.t("perpsToastInitiatingWithdrawal"));break;case"fundingBridgingStarted":break;case"fundingCompleted":this.success(Q.t("perpsToastWithdrawalComplete"));break;case"fundingFailed":this.failed(Q.t("perpsToastWithdrawalFailed"),e.error.message,Q.t("commandOK"),()=>{ee.getState().hideToast()});break}}success(e){setTimeout(()=>{ee.getState().success({message:e,onPress:a(()=>{ee.getState().hideToast()},"onPress")})},100)}failed(e,t,s,r){setTimeout(()=>{ee.getState().failed({title:e,message:t,buttonText:s,onPress:r})},100)}progress(e){setTimeout(()=>{ee.getState().progress({message:e,onPress:a(()=>{ee.getState().hideToast()},"onPress")})},100)}};h();l();h();l();h();l();h();l();h();l();h();l();h();l();var we=class{static{a(this,"RelayBridge")}account;authRepository;cashAccount;signer;solanaConnection;storage;constructor(e){this.account=e.account,this.authRepository=e.authRepository,this.cashAccount=e.cashAccount,this.signer=e.signer,this.solanaConnection=e.solanaConnection,this.storage=e.storage}getSolanaAddress(){let e=this.account.addresses.find(t=>t.addressType===se.Solana);if(!e)throw new Error("No Solana address found for account");return e.address}isCash(e){return e?.resourceType!==O.address||!this.cashAccount?!1:this.cashAccount.addressDetails.address===e.address}getTakerAddress(e){return e?.resourceType===O.address&&this.isCash(e)?e.address:this.getSolanaAddress()}getEvmAddress(){let e=this.account.addresses.find(t=>t.addressType===se.EVM);if(!e)throw new Error("No EVM address found for account");return e.address}async fetchQuotes(e){let t=this.getTakerAddress(e.fromTokenOwner),s=zt("kill-cash-perps-quote-chain-addresses"),r=this.getEvmAddress(),n=this.isCash(e.fromTokenOwner),d=this.account.addresses.reduce((c,u)=>({...c,[u.networkID]:u.address}),{}),p={sellToken:e.fromToken,buyToken:e.toToken,taker:{chainId:e.fromChain,address:t,resourceType:O.address},takerDestination:{chainId:e.toChain,address:r.toLowerCase(),resourceType:O.address},sellAmount:e.amount.toString(),slippageTolerance:(e.slippageBps??100)/100,phantomCashAccount:n,chainAddresses:s?void 0:d};m.addBreadcrumb(f.Perps,"Fetching Relay quotes",w.Info,{sellAmount:p.sellAmount,sellToken:b(p.sellToken),buyToken:b(p.buyToken),fromChain:p.sellToken.chainId,toChain:p.buyToken.chainId});try{let c=await F.api().retry(1,v(1e3,1e3)).post("/swap/v2/quotes",p);if(c.status!==200)throw new Error(`Failed to fetch quotes: ${c.status}`);let u=c.data;return m.addBreadcrumb(f.Perps,"Relay quotes fetched",w.Info,{quotesCount:u.quotes.length,firstQuoteBuyAmount:u.quotes[0]?.buyAmount}),u.quotes}catch(c){throw m.addBreadcrumb(f.Perps,"Failed to fetch Relay quotes",w.Error,{error:c instanceof Error?c.message:"Unknown error"}),c}}async executeSwap(e,t,s=de.Mainnet){let r=this.getTakerAddress(t),n=this.isCash(t),d=await Ai(r,e,this.solanaConnection);try{m.addBreadcrumb(f.Perps,"Executing Relay swap",w.Info,{buyAmount:e.buyAmount,sellAmount:e.sellAmount});let p=ae(),c=await this.authRepository?.getUser();if(!c)throw new Error("User not found for swap");let{accessToken:u,userID:S}=c,P;return n?P=await Yt({unsignedTransaction:vt(d),vaultProxy:this.signer,accountIdentifier:this.account.identifier,signerAddress:r,idempotencyKey:p,isCash:!0,accessToken:u,userID:S,skipActivityRecording:!1,swapInfo:void 0,perpsInfo:{type:"funding"},waitForActivityState:Jt.Completed}):(P=await Ce({accountIdentifier:this.account.identifier,accountSigner:this.signer,transaction:d,feePayer:new G.PublicKey(r),connection:this.solanaConnection,storage:this.storage,pendingTransactionInput:{ownerAddress:r,networkID:s,data:{signature:""},type:Ae.DappInteraction,display:{summary:{topLeft:{text:"Deposit"}}}}}),await Ee({connection:this.solanaConnection,signature:P})),m.addBreadcrumb(f.Perps,"Relay swap transaction sent",w.Info,{signature:P}),P}catch(p){throw m.addBreadcrumb(f.Perps,"Failed to send Relay swap transaction",w.Error,{error:p instanceof Error?p.message:"Unknown error"}),p}}};async function Ai(i,e,t){let s=xt(e.steps[0]?.transactionData,"bs58");s=await Ie(s,{connection:t});let r=new G.PublicKey(i);return await Lt(s,t),Ot(s,r),s}a(Ai,"transactionFromQuote");h();l();var bi=o.object({status:o.enum(["waiting","success","failure","refund","delayed","pending"]),requestId:o.string().optional()}),oe=class{static{a(this,"RelayBridgeStatusPoller")}pollInterval=null;listeners=new Set;POLL_INTERVAL_MS=1e3;MAX_POLL_ATTEMPTS=45;pollAttempts=0;subscribe(e){this.listeners.add(e)}unsubscribe(e){this.listeners.delete(e)}startPolling(e){this.pollAttempts=0,this.poll(e)}stopPolling(){this.pollInterval&&(clearTimeout(this.pollInterval),this.pollInterval=null)}async poll(e){this.pollAttempts++;try{let t=await this.fetchBridgeStatus(e);if(this.listeners.forEach(s=>s.onStatusUpdate(t)),t.status==="success"){m.addBreadcrumb(f.Perps,`Relay bridge completed for request: ${e}`,w.Info,{requestId:e}),this.listeners.forEach(s=>s.onCompleted(t)),this.stopPolling();return}if(t.status==="failure"||t.status==="refund"){let s=new Error(`Relay bridge failed with status: ${t.status} for request: ${e}`);m.addBreadcrumb(f.Perps,"Relay bridge failed",w.Error,{requestId:e,status:t.status}),this.listeners.forEach(r=>r.onError(s)),this.stopPolling();return}if(t.status!=="waiting"&&t.status!=="pending"&&t.status!=="delayed"){let s=new Error(`Unexpected Relay bridge status: ${t.status} for request: ${e}`);m.addBreadcrumb(f.Perps,"Relay bridge unexpected status",w.Error,{requestId:e,status:t.status}),this.listeners.forEach(r=>r.onError(s)),this.stopPolling();return}if(this.pollAttempts>=this.MAX_POLL_ATTEMPTS){let s=new Error(`Relay bridge status polling timed out with status: ${t.status} for request: ${e}`);m.addBreadcrumb(f.Perps,"Relay bridge polling timeout",w.Error,{requestId:e,finalStatus:t.status,attempts:this.pollAttempts}),this.listeners.forEach(r=>r.onError(s)),this.stopPolling();return}this.pollInterval=setTimeout(()=>{this.poll(e)},this.POLL_INTERVAL_MS)}catch(t){m.addBreadcrumb(f.Perps,`Error polling Relay bridge status for request: ${e}`,w.Error,{error:t instanceof Error?t.message:"Unknown error",requestId:e,attempts:this.pollAttempts}),this.listeners.forEach(s=>s.onError(t)),this.stopPolling()}}async fetchBridgeStatus(e){let t=await F.api().retry(1,v(1e3,1e3)).get("/swap/v2/spot/get-intents-status",{params:{requestId:e}});if(!L(t))throw new Error("Failed to get bridge status: response is not okay");let s=t.data,r=bi.safeParse(s);if(!r.success)throw new Error("Failed to get bridge status: schema validation failed");return r.data}};h();l();var V=class{static{a(this,"FundingTask")}startedAt;type;minimumUiAmount;amount;amountUsd;estimatedTime;fee;withdrawAddress;withdrawAddressRole;state={type:"indeterminate"};listeners=new Set;constructor(e,t,s,r,n,d){this.startedAt=Date.now(),this.type=e,this.minimumUiAmount=t,this.estimatedTime=s,this.fee=r,this.withdrawAddress=n,this.withdrawAddressRole=d}getState(){return this.state}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notify(e,t){this.listeners.forEach(s=>s.onFundingTaskStateChange(this,e,t))}getWithdrawAddressAndRole(){return{withdrawAddress:this.withdrawAddress,withdrawAddressRole:this.withdrawAddressRole}}};var _s=250,Ii=.05,Se=class i extends V{static{a(this,"RelayBridgeTask")}perps;account;authRepository;cashAccount;signer;storage;fromToken;fromTokenOwner;fromTokenDecimals;toToken;toTokenDecimals;fromChain;toChain;relayBridge;connection;bridgeListeners=new Set;quote;isFetchingQuote=!1;statusPoller;analytics;depositId;constructor(e,t,s,r,n,d,p,c,u,S,P,T,A,k,I,H,_){super("deposit",e,"",t),this.perps=s,this.account=r,this.authRepository=n,this.cashAccount=d,this.signer=p,this.storage=c,this.fromToken=u,this.fromTokenOwner=S,this.fromTokenDecimals=P,this.toToken=T,this.toTokenDecimals=A,this.fromChain=k,this.toChain=I,this.analytics=H,this.depositId=_||ae(),this.connection=be(de.Mainnet),this.relayBridge=new we({account:r,authRepository:n,cashAccount:d,signer:p,solanaConnection:this.connection,storage:c}),this.statusPoller=new oe,this.reportAnalytics(E.FUNDING_INITIALIZED,{})}reportAnalytics(e,t){let s={fundingType:"deposit",fundingRoute:K.Relay,amount:this.amount,amountUsd:this.amountUsd,fee:this.fee.toString(),estimatedTime:this.estimatedTime,fromToken:b(this.fromToken),toToken:b(this.toToken),fromChain:this.fromChain,toChain:this.toChain,depositId:this.depositId};this.analytics.reportDeposit(e,{...s,...t})}addBridgeListener(e){this.bridgeListeners.add(e)}removeBridgeListener(e){this.bridgeListeners.delete(e)}notifyBridgeListeners(e,...t){this.bridgeListeners.forEach(s=>{let r=s[e];typeof r=="function"&&r.call(s,...t)})}async fetchQuote(e,t){this.isFetchingQuote=!0;try{let s=e.shiftedBy(this.fromTokenDecimals),r=await this.relayBridge.fetchQuotes({amount:s.toNumber(),fromToken:this.fromToken,fromTokenOwner:this.fromTokenOwner,toToken:this.toToken,fromChain:this.fromChain,toChain:this.toChain,slippageBps:_s});return r.length===0?(this.isFetchingQuote=!1,null):(this.quote=r[0],this.fee=new g(this.quote.steps[0]?.feeCosts?.[0]?.value??Ii),m.addBreadcrumb(f.Perps,"Relay quote fetched",w.Info,{inputAmount:e.toString(),tokenPrice:t.toString(),inputUsd:e.toString(),outputUsd:e.toString(),feeUsd:this.fee.toString(),buyAmount:this.quote.buyAmount,sellAmount:this.quote.sellAmount,fromTokenDecimals:this.fromTokenDecimals,toTokenDecimals:this.toTokenDecimals}),this.notifyBridgeListeners("onQuoteFetched",this.quote),this.quote)}catch(s){return m.addBreadcrumb(f.Perps,"Failed to fetch Relay quote",w.Info,{error:s instanceof Error?s.message:"Unknown error"}),this.isFetchingQuote=!1,null}finally{this.isFetchingQuote=!1}}async execute(e,t,s){this.startedAt=Date.now(),this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),this.reportAnalytics(E.FUNDING_INITIATED,{});try{m.addBreadcrumb(f.Perps,"Fetching Relay bridge quotes",w.Info,{amount:s,fromChain:this.fromChain,toChain:this.toChain});let r=new g(s).shiftedBy(this.fromTokenDecimals),n=await this.relayBridge.fetchQuotes({amount:r.toNumber(),fromToken:this.fromToken,fromTokenOwner:this.fromTokenOwner,toToken:this.toToken,fromChain:this.fromChain,toChain:this.toChain,slippageBps:_s});if(n.length===0)throw new Error("No quotes available for bridge");this.quote=n[0],this.notifyBridgeListeners("onQuoteFetched",this.quote),this.notify({type:"fundingBridgingStarted"},this.state),this.notifyBridgeListeners("onBridgeStarted"),m.addBreadcrumb(f.Perps,"Executing Relay bridge swap",w.Info,{buyAmount:this.quote.buyAmount,sellAmount:this.quote.sellAmount});let d=await this.relayBridge.executeSwap(this.quote,this.fromTokenOwner);m.addBreadcrumb(f.Perps,"Relay bridge transaction submitted",w.Info,{txHash:d}),this.notifyBridgeListeners("onBridgeCompleted",d);let p=this.quote.steps[0].id;if(!p)throw new Error("No request ID found in Relay quote");this.startPollingForCompletion(p)}catch(r){let n=r;this.state={type:"failed",error:n},this.notify({type:"fundingFailed",error:n},this.state),this.notifyBridgeListeners("onBridgeFailed",n),m.addBreadcrumb(f.Perps,"Relay bridge failed",w.Error,{error:n.message}),this.reportAnalytics(E.FUNDING_FAILED,{error:JSON.stringify(n)})}}pause(){this.statusPoller.stopPolling(),m.addBreadcrumb(f.Perps,"Relay bridge pause requested - stopped polling",w.Info),this.reportAnalytics(E.FUNDING_PAUSED,{})}resume(){m.addBreadcrumb(f.Perps,"Relay bridge resume requested (no-op)",w.Info),this.reportAnalytics(E.FUNDING_RESUMED,{})}getFee(){return this.fee}startPollingForCompletion(e){let t={onStatusUpdate:a(s=>{m.addBreadcrumb(f.Perps,"Relay bridge status update",w.Info,{requestId:e,status:s.status})},"onStatusUpdate"),onCompleted:a(s=>{this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),m.addBreadcrumb(f.Perps,"Relay bridge funds received",w.Info,{requestId:e}),this.reportAnalytics(E.FUNDING_COMPLETED,{}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.statusPoller.unsubscribe(t)},"onCompleted"),onError:a(s=>{m.addBreadcrumb(f.Perps,"Relay bridge polling error",w.Error,{error:s.message,requestId:e}),this.statusPoller.unsubscribe(t),this.reportAnalytics(E.FUNDING_FAILED,{error:JSON.stringify(s)})},"onError")};this.statusPoller.subscribe(t),this.statusPoller.startPolling(e)}static create({minimumUiAmount:e,fee:t,perps:s,account:r,authRepository:n,cashAccount:d,signer:p,storage:c,fromToken:u,fromTokenOwner:S,fromTokenDecimals:P,toToken:T,toTokenDecimals:A,fromChain:k,toChain:I,analytics:H,depositId:_}){return new i(e,t,s,r,n,d,p,c,u,S,P,T,A,k,I,H,_)}};h();l();var Te=class extends V{static{a(this,"RelayWithdrawTask")}withdrawNetworkId;toTokenDecimals;perps;analytics;statusPoller;requestId;toTokenCaip19;fundingCaip19Address;constructor(e,t,s,r,n,d,p,c,u,S){super("withdraw",r,n,d,c,"user"),this.withdrawNetworkId=e,this.toTokenDecimals=t,this.perps=s,this.analytics=p,this.toTokenCaip19=u,this.fundingCaip19Address=S.fundingCaip19Address,this.statusPoller=new oe,this.reportAnalytics(C.FUNDING_INITIALIZED,{provider:K.Relay})}reportAnalytics(e,t){let s={fundingType:"withdraw",fundingRoute:K.Relay,amount:this.amount,amountUsd:this.amountUsd,withdrawAddress:this.withdrawAddress??"",withdrawNetworkId:this.withdrawNetworkId,minimumUiAmount:this.minimumUiAmount.toString(),estimatedTime:this.estimatedTime,fee:this.fee.toString()};this.analytics.reportWithdraw(e,{...s,...t})}pause(){this.statusPoller.stopPolling(),m.addBreadcrumb(f.Perps,"Relay withdrawal pause requested - stopped polling",w.Info),this.reportAnalytics(C.FUNDING_PAUSED,{})}resume(){m.addBreadcrumb(f.Perps,"Relay withdrawal resume requested (no-op)",w.Info),this.reportAnalytics(C.FUNDING_RESUMED,{})}async execute(e,t,s,r){this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state);try{if(m.addBreadcrumb(f.Perps,"Starting relay withdrawal",w.Info,{amount:s,amountUsd:t,withdrawAddress:this.withdrawAddress??""}),this.reportAnalytics(C.FUNDING_INITIALIZED,{}),!this.perps.user)throw new Error("No perps user available");let n=b(this.toTokenCaip19),d=e.shiftedBy(this.toTokenDecimals??8).toFixed(0),p=b({chainId:this.withdrawNetworkId,resourceType:O.address,address:this.withdrawAddress??""});m.addBreadcrumb(f.Perps,"Initializing relay bridge for withdrawal",w.Info,{sellAmount:d,buyToken:n,takerDestination:p});let c=await this.perps.client.getSpotBridgeInitialize({buyToken:n,sellAmount:d,takerDestination:p,bridgeProvider:K.Relay});this.requestId=c.requestId;let u=c.depositAddress.address;m.addBreadcrumb(f.Perps,"Relay bridge initialized",w.Info,{requestId:this.requestId,depositAddress:u}),this.notify({type:"fundingBridgingStarted",estimateTime:this.estimatedTime},this.state),m.addBreadcrumb(f.Perps,"Sending USDC from perps to relay deposit address",w.Info,{depositAddress:u,amount:e.toString()}),this.reportAnalytics(C.SEND_TO_WITHDRAW_ADDRESS_STARTED,{depositAddress:u,requestId:this.requestId}),await this.perps.usdSendPerps({destination:u,amount:e}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),m.addBreadcrumb(f.Perps,"Sent USDC from perps to relay deposit address",w.Info,{depositAddress:u,amount:e.toString()}),this.reportAnalytics(C.SEND_TO_WITHDRAW_ADDRESS_COMPLETED,{depositAddress:u}),this.startPollingForCompletion(this.requestId)}catch(n){let d=n instanceof Error?n:new Error("Unknown error");m.addBreadcrumb(f.Perps,"Relay withdrawal failed",w.Error,{error:d.message}),this.state={type:"failed",error:d},this.notify({type:"fundingFailed",error:d},this.state),this.reportAnalytics(C.FUNDING_FAILED,{error:d.message})}}startPollingForCompletion(e){let t={onStatusUpdate:a(s=>{m.addBreadcrumb(f.Perps,"Relay withdrawal status update",w.Info,{requestId:e,status:s.status})},"onStatusUpdate"),onCompleted:a(s=>{this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),m.addBreadcrumb(f.Perps,"Relay withdrawal completed",w.Info,{requestId:e}),this.reportAnalytics(C.FUNDING_COMPLETED,{requestId:e}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.statusPoller.unsubscribe(t)},"onCompleted"),onError:a(s=>{m.addBreadcrumb(f.Perps,"Relay withdrawal polling error",w.Error,{error:s.message,requestId:e}),this.statusPoller.unsubscribe(t),this.reportAnalytics(C.FUNDING_FAILED,{error:JSON.stringify(s)})},"onError")};this.statusPoller.subscribe(t),this.statusPoller.startPolling(e)}};h();l();var Ei=5,Ci={chainId:me.Mainnet,address:"0x00000000000000000000000000000000",resourceType:O.address},ki=8,st=class{static{a(this,"RelayBridgeFundingTaskFactory")}analytics;constructor(e){this.analytics=e}async createWithdrawTask(e,t,s){let r=t.addresses.find(u=>u.networkID===s);if(!r)throw new Error("Couldn't find destination account address for network: "+s);let n=r.address,d={chainId:s,resourceType:O.nativeToken,slip44:ie.getSlip44(s)},p={chainId:s,resourceType:O.address,address:n},c=await e.client.postFunding({type:"withdraw",taker:b(p),originChain:s});return new Te(s,ki,e,new g(c.minimumAmount),"5 seconds",new g(c.fee),this.analytics,n,d,{fundingCaip19Address:c.fundingCaip19Address})}async fetchTokenInfo(e,t,s,r,n){let d=e.addresses.find(T=>T.networkID===s);if(!d)throw new Error("Couldn't find result address for network: "+s);let p=new Xt,c={type:"swap",network:s,sellCaip19:b(r),buyCaip19:"solana:101/nativeToken:501",takerCaip19:n?b(n):void 0,takerDestinationCaip19:void 0},u=Qt(t),S=await p.initialize(c,[d],u);if(!S.sellTokenPrice?.usd)throw new Error("No price available for token");let P=S.sellToken;return{priceUsd:new g(S.sellTokenPrice.usd),decimals:P.data.decimals}}async createTask(e,t,s,r,n,d,p,c){if(c.type==="withdraw")return this.createWithdrawTask(e,t,c.withdrawNetworkId);let{depositTokenCaip19:u,depositTokenWalletCaip19:S}=c,{priceUsd:P,decimals:T}=await this.fetchTokenInfo(t,r,u.chainId,u,S),A=new g(Ei).dividedBy(P);return Se.create({minimumUiAmount:A,estimatedTime:"5 seconds",fee:new g(0),perps:e,account:t,authRepository:s,cashAccount:r,signer:d,storage:n,fromToken:u,fromTokenOwner:S,fromTokenDecimals:T,toToken:Ci,toTokenDecimals:18,fromChain:de.Mainnet,toChain:me.Mainnet,analytics:this.analytics,depositId:c.depositId})}};h();l();var jc=new g(5);var Fi=10,Et=class{static{a(this,"WarmFundingCache")}entries=new Map;refreshes=new Map;get(e,t){return this.entries.get(It(e,t))}set(e,t,s){let r=It(e,t);if(this.entries.set(r,s),this.entries.size>Fi){let n=Array.from(this.entries.keys())[0];this.entries.delete(n)}}delete(e,t){this.entries.delete(It(e,t))}keys(){return Array.from(this.entries.keys())}getByKey(e){return this.entries.get(e)}setRefresh(e,t){this.refreshes.set(e,t),t.finally(()=>this.refreshes.delete(e))}hasRefresh(e){return this.refreshes.has(e)}},bt=new Et;function It(i,e){let s={account:[...e.account.addresses].map(r=>`${r.networkID}:${r.address}`.toLowerCase()).sort().join("|")};return i.type==="deposit"?JSON.stringify({...s,type:"deposit",depositTokenCaip19:i.depositTokenCaip19,depositTokenWalletCaip19:i.depositTokenWalletCaip19,depositId:i.depositId}):JSON.stringify({...s,type:"withdraw",withdrawNetworkId:i.withdrawNetworkId})}a(It,"getFundingCacheKey");function Us(i){let e=Ri(i.account);for(let t of bt.keys())if(t.includes(`"account":"${e}"`)){let s=bt.getByKey(t);if(s){let r={...i};bt.delete(s.params,r)}}}a(Us,"invalidateAllForAccount");function Ri(i){return[...i.addresses].map(e=>`${e.networkID}:${e.address}`.toLowerCase()).sort().join("|")}a(Ri,"accountFingerprint");var it=class{static{a(this,"FundingWarmCacheListener")}getContext;constructor(e){this.getContext=e}onFundingPoolStateChange(e,t,s){if(e.type!=="fundingCompleted")return;let r=this.getContext();r&&Us(r)}};h();l();var qs="failedFundingEvents";var rt=class{static{a(this,"FailedFundingEventsCache")}storage;listeners=[];storageKey;accountId;constructor(e,t){this.storage=e,this.accountId=t,this.storageKey=this.generateStorageKey()}async setAccountId(e){if(this.accountId===e)return;this.accountId=e,this.storageKey=this.generateStorageKey();let t=await this.getEvents();this.notifyListeners(t)}generateStorageKey(){return this.accountId?`${qs}_${this.accountId}`:qs}async addEvent(e){let t=await this.getEvents(),s={id:`${e.type}_${e.startedAt}_${e.amountUsd}`,type:e.type,amountUsd:e.amountUsd||"0",timestamp:Date.now(),startedAt:e.startedAt,errorMessage:e.getState().type==="failed"?e.getState().error?.message:void 0};t.some(n=>n.id===s.id)||(t.unshift(s),t.length>25&&t.splice(25),await this.storage.set(this.storageKey,t),this.notifyListeners(t))}async getEvents(){let e=await this.storage.get(this.storageKey);return Array.isArray(e)?e:[]}async clear(){await this.storage.remove(this.storageKey),this.notifyListeners([])}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e){for(let t of this.listeners)t.onFailedEventsChange(e)}};h();l();var nt=class{static{a(this,"FundingPool")}activeTasks=new Set;listeners=new Set;failedEventsCache;constructor(e){this.failedEventsCache=e}setFailedEventsCache(e){this.failedEventsCache=e}async setAccountId(e){await this.failedEventsCache?.setAccountId(e)}submit(e,t,s,r,n){e.addListener(this.taskListener),this.activeTasks.add(e),e.execute(t,s,r,n)}getActiveTasks(){return Array.from(this.activeTasks)}getFailedEventsCache(){return this.failedEventsCache}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}pauseTasks(){this.activeTasks.forEach(e=>e.pause())}resumeTasks(){this.activeTasks.forEach(e=>e.resume())}taskListener={onFundingTaskStateChange:a((e,t,s)=>{switch(t.type){case"fundingStarted":break;case"fundingCompleted":this.activeTasks.delete(e),e.removeListener(this.taskListener);break;case"fundingFailed":e.removeListener(this.taskListener),this.failedEventsCache?.addEvent(e);break}this.listeners.forEach(r=>r.onFundingPoolStateChange(t,e,this.getActiveTasks()))},"onFundingTaskStateChange")}};h();l();h();l();h();l();h();l();var Di="perps_deposit_step";var ot=class{static{a(this,"DepositStepCache")}storage;listeners=[];userAddress=null;constructor(e){this.storage=e}setUserAddress(e){this.userAddress=e}getKey(){if(!this.userAddress)throw new Error("User address not set");return`${Di}_${this.userAddress}`}set(e,t){(async()=>{let s={step:e,startedAt:t||Date.now()};await this.storage.set(this.getKey(),s),this.notifyListeners(s)})()}clear(){(async()=>(await this.storage.remove(this.getKey()),this.notifyListeners(null)))()}async get(){if(!this.userAddress)return null;let e=await this.storage.get(this.getKey());if(!e)return null;let t=e;return Date.now()-t.startedAt>12e5?(this.clear(),null):t}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e){for(let t of this.listeners)t.onDepositStepChange(e)}};h();l();function Hs(i){return i.type==="idle"?"idle":i.type==="streamOperations"?`${i.sourceTxHash}:${i.depositAddress}`:`${i.type}:${i.depositAddress}`}a(Hs,"getDepositId");var Ct=null;function vi(i){return Ct||(Ct=new ot(i)),Ct}a(vi,"getDepositStepCache");var at=class{static{a(this,"DepositRecoverer")}perps;cache;analytics;constructor(e,t,s){this.perps=e,this.cache=vi(t),this.perps.user&&this.cache.setUserAddress(b(this.perps.user)),this.analytics=s}async getStuckDeposit(){this.perps.user&&this.cache.setUserAddress(b(this.perps.user));let e=await this.cache.get();return e?.step.type==="transfer"?(this.cache.clear(),null):e}async retry(e){if(e.type!=="streamOperations"){this.cache.clear();return}let t=Hs(e);try{let s=await this.pollForOperationCompletion(e);if(!s.destinationAmount)throw this.cache.clear(),new Error("Operation has no destination amount");let{destinationAmount:r}=s,n=await this.perps.spot.getTokenMidPrice(e.spotTokenId),{totalSz:d,avgPx:p}=await this.sellSpotAsset(new g(r),e.assetId,n,e.tokenDecimals,t);await this.transferToPerps(d,p,t),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.cache.clear()}catch{this.cache.clear();return}}async pollForOperationCompletion(e){let r=!1;for(let n=0;n<15;n++){let d=await this.perps.client.getOperations({taker:b(this.perps.user)}),p=`${e.sourceTxHash}:${e.depositAddress}`,c=d.operations.find(u=>u.sourceTxHash===p);if(c){if(r=!0,c.state==="failure")throw new Error("Operation failed");if(c.state==="done")return c}n<14&&await new Promise(u=>setTimeout(u,5e3))}throw r?new Error("Operation not done after maximum attempts"):new Error("Operation not found")}async sellSpotAsset(e,t,s,r,n){let d=e.shiftedBy(-r).decimalPlaces(3,g.ROUND_DOWN),p=await this.perps.spot.sell(t,d.toString(),s);return this.analytics.reportDeposit(E.DEPOSIT_SELL_SPOT_COMPLETED,{depositId:n,assetId:t,assetLimitPriceUsd:s,tokenDecimals:r,adjustedDepositedAmount:d}),{totalSz:new g(p.totalSz),avgPx:new g(p.avgPx)}}async transferToPerps(e,t,s){let r=e.multipliedBy(t).decimalPlaces(2,g.ROUND_DOWN).multipliedBy(.999);return await this.perps.transfer({toPerp:!0,amount:r}),this.analytics.reportDeposit(E.DEPOSIT_TRANSFER_TO_PERP_COMPLETED,{depositId:s,totalSz:e,avgPx:t,transferUsdcAmount:r}),r}};h();l();var dt=class{static{a(this,"HyperunitDepositStateMachine")}step={type:"idle"};listeners=[];setStep(e){this.step=e}completeStep(e){let t=this.step,s=this.detectNextStep(e);if(!s){this.listeners.forEach(r=>r.onStepCompleted(this.step,void 0)),this.listeners.forEach(r=>r.onDepositCompleted());return}this.step=s,this.listeners.forEach(r=>r.onStepCompleted(t,s))}detectNextStep(e){switch(e.stepType){case"idle":return{type:"transfer",depositAddress:e.depositAddress,depositAmount:e.amount};case"transfer":if(this.step.type!=="transfer")throw new Error("Invalid step: expected transfer, got "+this.step.type);return{...this.step,type:"streamOperations",senderAddress:e.senderAddress,networkId:e.networkId,tokenDecimals:e.tokenDecimals,sourceTxHash:e.txHash,assetId:e.assetId,spotTokenId:e.spotTokenId,assetLimitPriceUsd:e.assetLimitPriceUsd};case"streamOperations":if(this.step.type!=="streamOperations")throw new Error("Invalid step: expected streamOperations, got "+this.step.type);return{...this.step,type:"sellSpotAsset",destinationAmount:e.destinationAmount};case"sellSpotAsset":if(this.step.type!=="sellSpotAsset")throw new Error("Invalid step: expected sellSpotAsset, got "+this.step.type);return{...this.step,type:"transferToPerps",totalSz:e.totalSz,avgPx:e.avgPx};case"transferToPerps":if(this.step.type!=="transferToPerps")throw new Error("Invalid step: expected transferToPerps, got "+this.step.type);return}}failStep(e){this.listeners.forEach(t=>t.onDepositFailed(this.step,e))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}getStep(){return this.step}};h();l();var kt=class{static{a(this,"SolanaDepositTransfer")}sourceAddress;networkId;account;constructor(e,t,s){this.sourceAddress=e,this.networkId=t,this.account=s}async execute(e,t,s,r){let n=be(this.networkId),d=new Bt.Transaction().add(G.SystemProgram.transfer({fromPubkey:new G.PublicKey(this.sourceAddress),toPubkey:new G.PublicKey(t),lamports:e.toNumber()}));d=await Ie(d,{connection:n}),d.feePayer=new G.PublicKey(this.sourceAddress),await Mt(d,n);let p=await Ce({accountIdentifier:this.account.identifier,feePayer:new G.PublicKey(this.sourceAddress),connection:n,accountSigner:r,transaction:d,pendingTransactionInput:{ownerAddress:this.sourceAddress,networkID:this.networkId,data:{signature:""},type:Ae.DappInteraction,display:{summary:{topLeft:{text:"Deposit"}}}},storage:s});return await Ee({connection:n,signature:p}),{senderAddress:this.sourceAddress,networkId:this.networkId,tokenDecimals:9,txHash:p}}},ct=class{static{a(this,"DepositTransferFactory")}create(e,t){let s=e.chainId,r=t.addresses.find(n=>n.networkID===s)?.address;if(!r)throw new Error(`No source address found for networkID: ${s}`);if(ie.isSolanaNetworkID(s))return new kt(r,s,t);throw new Error(`Unsupported chain for deposit transfer: ${s}`)}};h();l();function Ft(i){switch(i.type){case"transfer":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString()};case"streamOperations":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString(),networkId:i.networkId,sourceTxHash:i.sourceTxHash};case"sellSpotAsset":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString(),networkId:i.networkId,sourceTxHash:i.sourceTxHash,destinationAmount:i.destinationAmount.toString()};case"transferToPerps":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString(),networkId:i.networkId,sourceTxHash:i.sourceTxHash,destinationAmount:i.destinationAmount.toString(),totalSz:i.totalSz.toString(),avgPx:i.avgPx.toString()};default:return{step:i.type}}}a(Ft,"getDepositStepLogsDetails");var Rt=a(i=>{switch(i.type){case"perpsToSpot":case"buyAsset":return{assetId:i.assetId.toString(),withdrawAddress:i.withdrawAddress,withdrawAmountUsd:i.withdrawAmountUsd.toString()};case"sendToWithdrawAddress":return{assetId:i.assetId.toString(),withdrawAddress:i.withdrawAddress,withdrawAmountUsd:i.withdrawAmountUsd.toString(),assetMidPrice:i.assetMidPrice.toString(),filledAmount:i.filledAmount.toString()};case"streamOperations":return{assetId:i.assetId.toString(),withdrawAddress:i.withdrawAddress,withdrawAmountUsd:i.withdrawAmountUsd.toString(),sendToWithdrawAmount:i.sendToWithdrawAmount.toString(),operationStartTime:i.operationStartTime.toISOString()};default:return{step:i.type}}},"getWithdrawStepLogsDetails");h();l();var le=class{static{a(this,"OperationsStreamer")}perpsClient;streamOpen=!1;listeners=[];interval=2e3;constructor(e){this.perpsClient=e}startStream(e,t,s){this.streamOpen=!0,this.stream(b(e),t,s)}startWithdrawStream(e,t,s){this.streamOpen=!0,this.streamWithdraw(b(e),t,s)}stream(e,t,s){this.streamOpen&&(async()=>{try{let r=await this.perpsClient.getOperations({taker:e}),n=`${t}:${s}`,d=r.operations.find(p=>p.sourceTxHash===n);this.listeners.forEach(p=>{p.onOperation(r,d)}),this.streamOpen&&setTimeout(()=>this.stream(e,t,s),this.interval)}catch(r){this.listeners.forEach(n=>{n.onError(r)}),this.stopStream()}})()}streamWithdraw(e,t,s){this.streamOpen&&(async()=>{try{let r=await this.perpsClient.getOperations({taker:e}),n=this.findMatchingWithdrawOperation(r.operations,t,s);this.listeners.forEach(d=>{d.onOperation(r,n)}),this.streamOpen&&setTimeout(()=>this.streamWithdraw(e,t,s),this.interval)}catch(r){this.listeners.forEach(n=>{n.onError(r)}),this.stopStream()}})()}findMatchingWithdrawOperation(e,t,s){let r=e.filter(n=>{if(n.sourceChain!=="hyperliquid"||n.destinationChain!=="solana"||!n.opCreatedAt)return!1;let d=new Date(n.opCreatedAt).getTime(),p=Math.abs(d-t.getTime()),c=4*60*1e3;if(p>c)return!1;if(n.sourceAmount){let u=new g(n.sourceAmount).dividedBy(10**ke.data.decimals),S=s,P=u.minus(S).abs(),T=S.multipliedBy(.1);if(P.isGreaterThan(T))return!1}return!0});if(r.length!==0)return r.sort((n,d)=>new Date(d.opCreatedAt).getTime()-new Date(n.opCreatedAt).getTime())[0]}stopStream(){this.streamOpen=!1}subscribe(e){return this.listeners.push(e),()=>this.unsubscribe(e)}unsubscribe(e){this.listeners=this.listeners.filter(t=>t!==e)}};var pt=class i extends V{static{a(this,"HyperunitDepositTask")}perps;assetId;spotTokenId;depositTokenCaip19;account;depositAddress;storage;signer;stateMachine=new dt;depositTransferFactory=new ct;operationsStreamer;depositRecoverer;fundingState="active";analytics;depositId;constructor(e,t,s,r,n,d,p,c,u,S,P,T,A){super("deposit",e,t,s),this.perps=r,this.assetId=n,this.spotTokenId=d,this.depositTokenCaip19=p,this.account=c,this.depositAddress=u,this.storage=S,this.signer=P,this.analytics=T,this.stateMachine.addListener(this.stateMachineListener),this.stateMachine.addListener(this.stateLogsListener),this.operationsStreamer=new le(this.perps.client),this.depositRecoverer=new at(this.perps,this.storage,this.analytics),this.perps.user&&this.depositRecoverer.cache.setUserAddress(b(this.perps.user)),this.depositId=A||ae(),this.reportAnalytics(E.FUNDING_INITIALIZED,{})}reportAnalytics(e,t){let s={fundingType:"deposit",fundingRoute:K.Hyperunit,amount:this.amount,amountUsd:this.amountUsd,fee:this.fee.toString(),estimatedTime:this.estimatedTime,assetId:this.assetId,spotTokenId:this.spotTokenId,depositTokenCaip19:b(this.depositTokenCaip19),depositAddress:this.depositAddress,depositId:this.depositId};this.analytics.reportDeposit(e,{...s,...t})}stateMachineListener={onStepCompleted:a((e,t)=>{this.fundingState!=="paused"&&(e.type==="transfer"&&this.notify({type:"fundingBridgingStarted",estimateTime:this.estimatedTime},this.state),t&&(this.depositRecoverer.cache.set(t,this.startedAt),this.executeStep(t)))},"onStepCompleted"),onDepositCompleted:a(()=>{this.depositRecoverer.cache.clear(),this.stateMachine.removeListener(this.stateMachineListener),this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),this.reportAnalytics(E.FUNDING_COMPLETED,{})},"onDepositCompleted"),onDepositFailed:a((e,t)=>{console.error(`Deposit failed at step: ${e.type}`,t),this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.removeListener(this.stateMachineListener),this.state={type:"failed",error:t},this.notify({type:"fundingFailed",error:t},this.state),this.reportAnalytics(E.FUNDING_FAILED,{error:JSON.stringify(t)})},"onDepositFailed")};stateLogsListener={onStepCompleted:a((e,t)=>{m.addBreadcrumb(f.Perps,`Deposit step completed: ${e.type}`,w.Info,{...Ft(e),amountUsd:this.amountUsd??""})},"onStepCompleted"),onDepositCompleted:a(()=>{this.stateMachine.removeListener(this.stateLogsListener)},"onDepositCompleted"),onDepositFailed:a((e,t)=>{m.addBreadcrumb(f.Perps,`Deposit failed at step: ${e.type}`,w.Error,{error:t instanceof Error?t.message:"Unknown error",...Ft(e),amountUsd:this.amountUsd??""}),this.stateMachine.removeListener(this.stateLogsListener)},"onDepositFailed")};execute(e,t,s,r){if(this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),r){this.stateMachine.setStep(r.state),this.stateMachine.completeStep(r.completedStep);return}this.stateMachine.completeStep({stepType:"idle",depositAddress:this.depositAddress,amount:e})}pause(){this.fundingState="paused",this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.reportAnalytics(E.FUNDING_PAUSED,{})}resume(){this.fundingState="active";let e=this.stateMachine.getStep();e.type==="streamOperations"&&((async()=>{try{if(!this.perps.user)return;let t=await this.perps.client.getOperations({taker:b(this.perps.user)}),s=`${e.sourceTxHash}:${e.depositAddress}`,r=t.operations.find(n=>n.sourceTxHash===s);r&&r.state==="done"?this.processOperation(r):this.executeStep(e)}catch{this.executeStep(e)}})(),this.reportAnalytics(E.FUNDING_RESUMED,{}))}executeStep(e){(async()=>{try{switch(e.type){case"transfer":this.reportAnalytics(E.DEPOSIT_TRANSFER_STARTED,{...e});let{senderAddress:t,networkId:s,tokenDecimals:r,txHash:n}=await this.transfer(e.depositAmount),d=await this.perps.spot.getTokenMidPrice(this.spotTokenId);this.stateMachine.completeStep({stepType:"transfer",senderAddress:t,networkId:s,tokenDecimals:r,txHash:n,assetId:this.assetId,spotTokenId:this.spotTokenId,assetLimitPriceUsd:d}),this.reportAnalytics(E.DEPOSIT_TRANSFER_COMPLETED,{...e,senderAddress:t,networkId:s,tokenDecimals:r,txHash:n,assetLimitPriceUsd:d});break;case"streamOperations":this.reportAnalytics(E.DEPOSIT_STREAM_OPERATIONS_STARTED,{...e}),this.startOperationsStream(e.sourceTxHash,e.depositAddress),this.reportAnalytics(E.DEPOSIT_STREAM_OPERATIONS_COMPLETED,{...e});break;case"sellSpotAsset":this.reportAnalytics(E.DEPOSIT_SELL_SPOT_STARTED,{...e});let p=await this.sellSpotAsset(e.depositAmount,e.tokenDecimals);this.stateMachine.completeStep({stepType:"sellSpotAsset",...p}),this.reportAnalytics(E.DEPOSIT_SELL_SPOT_COMPLETED,{...e,...p});break;case"transferToPerps":this.reportAnalytics(E.DEPOSIT_TRANSFER_TO_PERP_STARTED,{...e});let c=await this.transferToPerps(e.totalSz,e.avgPx);this.stateMachine.completeStep({stepType:"transferToPerps",transferUsdcAmount:c}),this.reportAnalytics(E.DEPOSIT_TRANSFER_TO_PERP_COMPLETED,{...e,transferUsdcAmount:c});break}}catch(t){this.stateMachine.failStep(t)}})()}async transfer(e){return await this.depositTransferFactory.create(this.depositTokenCaip19,this.account).execute(e,this.depositAddress,this.storage,this.signer)}startOperationsStream(e,t){if(this.operationsStreamer.subscribe(this.operationsStreamListener),!this.perps.user)throw new Error("No perps user");this.operationsStreamer.startStream(this.perps.user,e,t)}operationsStreamListener={onOperation:a((e,t)=>{t&&this.processOperation(t)},"onOperation"),onError:a(e=>{this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.failStep(e)},"onError")};processOperation(e){if(e.state==="failure"){this.stateMachine.failStep(new Error("Operation failed"));return}if(e.state==="done"){if(this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.operationsStreamer.stopStream(),!e.destinationAmount)throw new Error("Destination amount is required");this.stateMachine.completeStep({stepType:"streamOperations",destinationAmount:new g(e.destinationAmount)})}}async sellSpotAsset(e,t){let s=e.shiftedBy(-t).decimalPlaces(3,g.ROUND_DOWN),r=await this.perps.spot.getTokenMidPrice(this.spotTokenId),n=await this.perps.spot.sell(this.assetId,s.toString(),r);return{totalSz:new g(n.totalSz),avgPx:new g(n.avgPx)}}async transferToPerps(e,t){let s=e.multipliedBy(t).decimalPlaces(2,g.ROUND_DOWN).multipliedBy(.999);return await this.perps.transfer({toPerp:!0,amount:s}),s}static create({minimumUiAmount:e,estimatedTime:t,fee:s,perps:r,assetId:n,spotTokenId:d,depositTokenCaip19:p,account:c,depositAddress:u,storage:S,signer:P,analytics:T,depositId:A}){return new i(e,t,s,r,n,d,p,c,u,S,P,T,A)}};h();l();h();l();var zs={1:7e-4,2:6e-4,3:5e-4,4:4e-4,5:35e-5,6:3e-4,7:.0025,8:.002};h();l();var ht=class{static{a(this,"HyperunitWithdrawStateMachine")}step;constructor(e){e?this.step=e:this.step={type:"idle"}}setStep(e){this.step=e}listeners=[];completeStep(e){let t=this.step,s=this.detectNextStep(e);if(!s){this.listeners.forEach(r=>r.onStepCompleted(this.step,void 0)),this.listeners.forEach(r=>r.onWithdrawCompleted());return}this.step=s,this.listeners.forEach(r=>r.onStepCompleted(t,s))}failStep(e){this.listeners.forEach(t=>t.onWithdrawFailed(this.step,e))}detectNextStep(e){switch(e.stepType){case"idle":return{type:"perpsToSpot",withdrawAddress:e.withdrawAddress,assetId:e.assetId,estimatedTime:e.estimatedTime,withdrawAmountUsd:e.withdrawAmountUsd};case"perpsToSpot":if(this.step.type!=="perpsToSpot")throw new Error("Invalid step: expected perpsToSpot, got "+this.step.type);return{...this.step,type:"buyAsset"};case"buyAsset":if(this.step.type!=="buyAsset")throw new Error("Invalid step: expected buyAsset, got "+this.step.type);return{...this.step,type:"sendToWithdrawAddress",assetMidPrice:e.assetMidPrice,filledAmount:e.filledAmount};case"sendToWithdrawAddress":if(this.step.type!=="sendToWithdrawAddress")throw new Error("Invalid step: expected sendToWithdrawAddress, got "+this.step.type);return{...this.step,type:"streamOperations",sendToWithdrawAmount:e.sendToWithdrawAmount,operationStartTime:new Date};case"streamOperations":if(this.step.type!=="streamOperations")throw new Error("Invalid step: expected streamOperations, got "+this.step.type);return}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}getStep(){return this.step}};var lt=class extends V{static{a(this,"HyperunitWithdrawTask")}withdrawAddress;withdrawAddressRole;assetId;spotTokenName;spotTokenId;perps;stateMachine=new ht;analytics;operationsStreamer;fundingState="active";constructor(e,t,s,r,n,d,p,c,u,S){super("withdraw",p,c,u),this.withdrawAddress=e,this.withdrawAddressRole=t,this.assetId=s,this.spotTokenName=r,this.spotTokenId=n,this.perps=d,this.analytics=S,this.stateMachine.addListener(this.withdrawStateMachineListener),this.stateMachine.addListener(this.stateLogsListener),this.operationsStreamer=new le(this.perps.client),this.reportAnalytics(C.FUNDING_INITIALIZED,{})}reportAnalytics(e,t){let s={fundingType:"withdraw",amount:this.amount,amountUsd:this.amountUsd,withdrawAddress:this.withdrawAddress,withdrawAddressRole:this.withdrawAddressRole,assetId:this.assetId,spotTokenName:this.spotTokenName,spotTokenId:this.spotTokenId,minimumUiAmount:this.minimumUiAmount.toString(),estimatedTime:this.estimatedTime,fee:this.fee.toString()};this.analytics.reportWithdraw(e,{...s,...t})}withdrawStateMachineListener={onStepCompleted:a((e,t)=>{this.fundingState!=="paused"&&(e.type==="sendToWithdrawAddress"&&this.notify({type:"fundingBridgingStarted",estimateTime:"4"},this.state),t&&this.executeStep(t))},"onStepCompleted"),onWithdrawCompleted:a(()=>{this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.removeListener(this.withdrawStateMachineListener),this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),this.reportAnalytics(C.FUNDING_COMPLETED,{})},"onWithdrawCompleted"),onWithdrawFailed:a((e,t)=>{console.error(`Withdraw failed at step: ${e.type}`,t),this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.removeListener(this.withdrawStateMachineListener),this.state={type:"failed",error:t},this.notify({type:"fundingFailed",error:t},this.state),this.reportAnalytics(C.FUNDING_FAILED,{error:JSON.stringify(t)})},"onWithdrawFailed")};stateLogsListener={onStepCompleted:a((e,t)=>{m.addBreadcrumb(f.Perps,`Withdraw step completed: ${e.type}`,w.Info,{...Rt(e),amountUsd:this.amountUsd??""})},"onStepCompleted"),onWithdrawCompleted:a(()=>{this.stateMachine.removeListener(this.stateLogsListener)},"onWithdrawCompleted"),onWithdrawFailed:a((e,t)=>{m.addBreadcrumb(f.Perps,`Withdraw failed at step: ${e.type}`,w.Error,{error:t instanceof Error?t.message:"Unknown error",...Rt(e),amountUsd:this.amountUsd??""}),this.stateMachine.removeListener(this.stateLogsListener)},"onWithdrawFailed")};pause(){this.fundingState="paused",this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.reportAnalytics(C.FUNDING_PAUSED,{})}resume(){this.fundingState="active";let e=this.stateMachine.getStep();e.type==="streamOperations"&&(this.perps.user&&this.executeStep(e),this.reportAnalytics(C.FUNDING_RESUMED,{}))}execute(e,t,s,r){if(this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),r){this.stateMachine.setStep(r.state),this.stateMachine.completeStep(r.completedStep);return}this.stateMachine.completeStep({stepType:"idle",withdrawAddress:this.withdrawAddress,assetId:this.assetId,estimatedTime:this.estimatedTime??"",withdrawAmountUsd:e})}executeStep(e){(async()=>{try{switch(e.type){case"perpsToSpot":this.reportAnalytics(C.PERPS_TO_SPOT_STARTED,e),await this.transferToSpot(e.withdrawAmountUsd),this.reportAnalytics(C.PERPS_TO_SPOT_COMPLETED,e);break;case"buyAsset":this.reportAnalytics(C.BUY_ASSET_STARTED,e),await this.buyAsset(e.assetId,e.withdrawAmountUsd),this.reportAnalytics(C.BUY_ASSET_COMPLETED,e);break;case"sendToWithdrawAddress":this.reportAnalytics(C.SEND_TO_WITHDRAW_ADDRESS_STARTED,e),await this.sendToWithdrawAddress(this.spotTokenName,this.spotTokenId,e.filledAmount),this.reportAnalytics(C.SEND_TO_WITHDRAW_ADDRESS_COMPLETED,e);break;case"streamOperations":this.reportAnalytics(C.WITHDRAW_STREAM_OPERATIONS_STARTED,e),this.startOperationsStream(e),this.reportAnalytics(C.WITHDRAW_STREAM_OPERATIONS_COMPLETED,e);break}}catch(t){this.stateMachine.failStep(t)}})()}async transferToSpot(e){let t=this.withdrawAddressRole==="missing"?new g(1):new g(0);await this.perps.transfer({toPerp:!1,amount:e.minus(t)}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.stateMachine.completeStep({stepType:"perpsToSpot"})}async buyAsset(e,t){let s=await this.perps.spot.getTokenMidPrice(this.spotTokenId),r=t.dividedBy(s.multipliedBy(Qe)).decimalPlaces(3),n=await this.perps.spot.buy(e,r.toString(),s),d=zs[1];this.stateMachine.completeStep({stepType:"buyAsset",assetMidPrice:s,filledAmount:new g(n.totalSz).multipliedBy(1-d)})}async sendToWithdrawAddress(e,t,s){let r=this.fee.dividedBy(10**ke.data.decimals),n=s.minus(r).decimalPlaces(3,g.ROUND_DOWN);await this.perps.spot.send(e,t,n,this.withdrawAddress),this.stateMachine.completeStep({stepType:"sendToWithdrawAddress",sendToWithdrawAmount:n})}startOperationsStream(e){if(e.type!=="streamOperations")throw new Error("Invalid step type for operations stream");if(this.operationsStreamer.subscribe(this.operationsStreamListener),!this.perps.user)throw new Error("No perps user");this.operationsStreamer.startWithdrawStream(this.perps.user,e.operationStartTime,e.sendToWithdrawAmount)}operationsStreamListener={onOperation:a((e,t)=>{t&&this.processOperation(t)},"onOperation"),onError:a(e=>{this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.failStep(e)},"onError")};processOperation(e){if(e.state==="failure"){this.stateMachine.failStep(new Error("Withdrawal operation failed"));return}e.state==="done"&&(this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.operationsStreamer.stopStream(),this.stateMachine.completeStep({stepType:"streamOperations"}))}getWithdrawAddressAndRole(){return{withdrawAddress:this.withdrawAddress,withdrawAddressRole:this.withdrawAddressRole}}};var ut=class{static{a(this,"HyperunitFundingTaskFactory")}analytics;constructor(e){this.analytics=e}async createTask(e,t,s,r,n,d,p,c){switch(c.type){case"deposit":return this.createDepositTask(e,t,c.depositTokenCaip19,p,n,d,c.depositId);case"withdraw":return this.createWithdrawTask(e,c.withdrawNetworkId,t)}}async createDepositTask(e,t,s,r,n,d,p){let{fundingCaip19Address:c,spotAssetId:u,eta:S,minimumAmount:P,spotTokenId:T,fee:A}=await e.client.postFunding({type:"deposit",taker:b(r),originChain:s.chainId}),k=this.checkCaip19Address(c);return pt.create({minimumUiAmount:new g(P),estimatedTime:S,fee:new g(A),perps:e,assetId:u,spotTokenId:T,depositTokenCaip19:s,account:t,depositAddress:k,storage:n,signer:d,analytics:this.analytics,depositId:p})}async createWithdrawTask(e,t,s){let r=s.addresses.find(k=>k.networkID===t);if(!r)throw new Error("Couldn't find destination account address for network: "+t);let{fundingCaip19Address:n,spotAssetId:d,eta:p,minimumAmount:c,spotTokenName:u,spotTokenId:S,fee:P}=await e.client.postFunding({type:"withdraw",taker:b({resourceType:O.address,chainId:r.networkID,address:r.address}),originChain:t}),T=this.checkCaip19Address(n),A=await e.client.getUserRole(T);return new lt(T,A.role,d,u,S,e,new g(c),p,new g(P),this.analytics)}checkCaip19Address(e){let t=Ut(e);if(t.resourceType!==O.address)throw new Error("Funding CAIP19 is not an address");return t.address}};h();l();var Dt=class extends V{static{a(this,"MockFundingTask")}shouldFail;constructor(e,t=!1){super(e,new g(.01),"1m",new g(8471530)),this.shouldFail=t}execute(e,t,s){this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),setTimeout(()=>{if(this.notify({type:"fundingBridgingStarted",estimateTime:this.estimatedTime},this.state),this.shouldFail){setTimeout(()=>{this.state={type:"failed",error:new Error("Mock funding task failed")},this.notify({type:"fundingFailed",error:new Error("Mock funding task failed")},this.state)},3e3);return}setTimeout(()=>{this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state)},3e3)},3e3)}pause(){}resume(){}},Pe=class{static{a(this,"MockFundingTaskFactory")}createTask(e,t,s,r,n,d,p,c){return Promise.resolve(new Dt(c.type,!1))}};var $s=(0,Z.createContext)(null),js=!1;function hl({fundingPoolFactory:i,children:e}){let t=Ns(),s=qt(),r=Kt(),n=Wt(),d=Ht("enable-perps-funding-warm"),p=(0,Z.useMemo)(()=>{let S;if(i)S=i.create();else{let A=new rt(s);S=new nt(A)}S.addListener(new tt),S.addListener(new et),d&&S.addListener(new it(()=>{let A=p.account,k=p.user;if(!(!A||!k))return{account:A,user:k,cashAccount:void 0,storage:s,perps:p,determineProvider:a(()=>{},"determineProvider"),getAvailableProviders:a(()=>[],"getAvailableProviders")}}));let P=js?new Pe:new st(t),T=js?new Pe:new ut(t);return new Ze({client:new De,isTestnet:r,fundingPool:S,relayFundingTaskFactory:P,hyperunitFundingTaskFactory:T,authRepository:n})},[i,t,s,r,n,d]),{data:c}=Gt();(0,Z.useEffect)(()=>{c&&p.setAccount(c)},[c,p]);let u=jt();return(0,Z.useEffect)(()=>{p.setSigner(u)},[u,p]),(0,Ws.jsx)($s.Provider,{value:p,children:e})}a(hl,"PerpsProvider");function Gs(){let i=(0,Z.useContext)($s);if(!i)throw new Error("usePerps must be used within a PerpsProvider");return i}a(Gs,"usePerpsContext");h();l();var R=q(ft());var yl=a(()=>{let i=Gs(),e=(0,R.useCallback)(()=>{i.syncAccountBalance()},[i]),[t,s]=(0,R.useState)(i.getAccountBalanceState());(0,R.useEffect)(()=>i.subscribeAccountBalanceState({onAccountBalanceStateChange:a(D=>{s(D)},"onAccountBalanceStateChange")}),[i]);let r=(0,R.useCallback)(()=>{i.syncPositions()},[i]),[n,d]=(0,R.useState)(i.getPositionsState());(0,R.useEffect)(()=>i.subscribePositions({onPositionStateChange:a(D=>{d(D)},"onPositionStateChange")}),[i]);let p=(0,R.useCallback)(()=>{i.syncPositionFees()},[i]),[c,u]=(0,R.useState)(i.getPositionFeesState());(0,R.useEffect)(()=>i.subscribePositionFees({onPositionFeesStateChange:a(D=>{u(D)},"onPositionFeesStateChange")}),[i]);let S=(0,R.useCallback)(()=>{i.syncFundingHistory()},[i]),[P,T]=(0,R.useState)(i.getFundingHistoryState());(0,R.useEffect)(()=>i.subscribeFundingHistory({onFundingHistoryStateChange:a(D=>{T(D)},"onFundingHistoryStateChange")}),[i]);let A=(0,R.useCallback)(D=>{i.syncHistoricalOrders(D)},[i]),[k,I]=(0,R.useState)(i.getHistoricalOrdersState());(0,R.useEffect)(()=>i.subscribeHistoricalOrders({onHistoricalOrdersStateChange:a(D=>{I(D)},"onHistoricalOrdersStateChange")}),[i]);let H=(0,R.useCallback)((D,ue,gt,U)=>{i.syncPricing(D,ue,gt,U)},[i]),_=(0,R.useCallback)(D=>{i.startSequentialPricingSync(D)},[i]),[J,M]=(0,R.useState)(i.getPricingState());(0,R.useEffect)(()=>i.subscribePricing({onPricingStateChange:a(D=>{M(D)},"onPricingStateChange")}),[i]);let Y=(0,R.useCallback)(()=>i.getAccountBalanceState(),[i]);return{isReady:i.getUser()!==void 0,accountBalanceState:t,syncAccountBalance:e,getAccountBalanceState:Y,positionsState:n,syncPositions:r,positionFeesState:c,syncPositionFees:p,fundingHistoryState:P,syncFundingHistory:S,historicalOrdersState:k,syncHistoricalOrders:A,pricingState:J,syncPricing:H,startSequentialPricingSync:_}},"usePerps");export{is as a,Re as b,as as c,hl as d,yl as e};
//# sourceMappingURL=chunk-4BMGGNRO.js.map
