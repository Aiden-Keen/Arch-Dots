import{a as D}from"./chunk-SG46YPDZ.js";import{jc as ce,mc as q,xc as me}from"./chunk-TAPPRV2Q.js";import{a as M,b as W}from"./chunk-WVRYN4MY.js";import{e as _}from"./chunk-M3IC3XCG.js";import{j as I}from"./chunk-2UWPPO5V.js";import{a as ie,b as C}from"./chunk-MVNJOY5H.js";import{a as b}from"./chunk-YJCG6GWC.js";import{$ as se,Da as oe,G as Z,Ja as o,L,T as ee,_ as te,aa as re,ea as ae}from"./chunk-KLKDJF5S.js";import{S as ne}from"./chunk-BQE2SXP7.js";import{Ac as j,Bc as z,Cc as x,Fc as u,Id as K,Mc as Y,Nc as J,Pc as X,Rd as Q,Td as w}from"./chunk-L3JU23Z5.js";import{a as $}from"./chunk-VL3IRAUM.js";import{y as T}from"./chunk-FA7LVEFF.js";import{a as s,g as N,i as n,j as l,n as i}from"./chunk-WKJYWAXG.js";n();i();n();i();var S={Accounts:`${L}.accounts`,SecretIdentifiers:`${L}.secrets`},le=[{legacyKeys:[o.AccountsMetadata],targetSchema:"accounts",targetKey:o.AccountsMetadata,migrate:s(e=>e[o.AccountsMetadata],"migrate")}],ge=[{legacyKeys:[o.DeveloperMode],targetSchema:"accounts",targetKey:o.DeveloperMode,migrate:s(e=>e[o.DeveloperMode],"migrate")},{legacyKeys:[o.NetworkSetting],targetSchema:"accounts",targetKey:o.NetworkSetting,migrate:s(e=>e[o.NetworkSetting],"migrate")},{legacyKeys:[o.SelectedAccount],targetSchema:"accounts",targetKey:o.SelectedAccount,migrate:s(e=>e[o.SelectedAccount],"migrate")},{legacyKeys:[o.AccountsBalanceMetadata],targetSchema:"accounts",targetKey:o.AccountsBalanceMetadata,migrate:s(e=>e[o.AccountsBalanceMetadata],"migrate")},{legacyKeys:[o.MigratedWithInvalidChecksum],targetSchema:"accounts",targetKey:o.MigratedWithInvalidChecksum,migrate:s(e=>e[o.MigratedWithInvalidChecksum],"migrate")},{legacyKeys:[o.TermsHaveBeenAcknowledgedLastSeenVersion],targetSchema:"accounts",targetKey:o.TermsHaveBeenAcknowledgedLastSeenVersion,migrate:s(e=>e[o.TermsHaveBeenAcknowledgedLastSeenVersion],"migrate")},{legacyKeys:[o.NotificationsHaveBeenAcknowledgedLastSeenVersion],targetSchema:"accounts",targetKey:o.NotificationsHaveBeenAcknowledgedLastSeenVersion,migrate:s(e=>e[o.NotificationsHaveBeenAcknowledgedLastSeenVersion],"migrate")}],pe=[{legacyKeys:[S.Accounts],targetSchema:"vault",targetKey:S.Accounts,migrate:s(e=>e[S.Accounts],"migrate")},{legacyKeys:[S.SecretIdentifiers],targetSchema:"vault",targetKey:S.SecretIdentifiers,migrate:s(e=>e[S.SecretIdentifiers],"migrate")}];n();i();n();i();var d;(function(e){e.DismissedActionBanners="dismissedActionBanners",e.AppLaunchTimes="appLaunchTimes",e.LastOnboardedAt="lastOnboardedAt",e.DismissedContentCards=".phantom.interstitials.contentCards.dismissed"})(d||(d={}));var de=[{legacyKeys:[d.DismissedActionBanners],targetSchema:"interstitials",targetKey:I.DismissedActionBanners,migrate:s(e=>e[d.DismissedActionBanners],"migrate")},{legacyKeys:[d.AppLaunchTimes],targetSchema:"interstitials",targetKey:I.AppLaunchTimes,migrate:s(e=>e[d.AppLaunchTimes],"migrate")},{legacyKeys:[d.LastOnboardedAt],targetSchema:"interstitials",targetKey:I.LastOnboardedAt,migrate:s(e=>e[d.LastOnboardedAt],"migrate")},{legacyKeys:[d.DismissedContentCards],targetSchema:"interstitials",targetKey:I.DismissedContentCards,migrate:s(e=>e[d.DismissedContentCards],"migrate")}];n();i();var h=N(b());n();i();var Ie=s(e=>typeof e=="object"&&e!==null&&"localVersion"in e&&"remoteVersion"in e&&"remoteState"in e&&"eventVersions"in e,"isNamespaceState"),U=s(e=>Ie(e)?e:{localVersion:0,remoteVersion:0,remoteState:null,eventVersions:{change:0,idle:0}},"parseNamespaceState");var V=s(e=>typeof e=="object"&&e!==null?e:{},"parseNamespaceItems");var P="mmkv:state:",F="mmkv:items:",k=s(e=>`${P}${e}`,"namespaceStateKey"),v=s(e=>`${F}${e}`,"namespaceItemsKey"),Ce=s(e=>e.startsWith(P),"isNamespaceStateKey"),Ee=s(e=>e.startsWith(F),"isNamespaceItemsKey"),O=class{static{s(this,"ExtensionBackingStore")}stateCache={};itemsCache={};callbacks={};async init(t){let r=await h.default.storage.local.get([...t.map(a=>k(a.key)),...t.map(a=>v(a.key))]);for(let a of t){let c=a.key,m=k(c),p=v(c);this.stateCache[c]=U(r[m]),this.itemsCache[c]=V(r[p])}h.default.storage.local.onChanged.addListener(a=>{let c=[];for(let[m,p]of Object.entries(a))if(Ce(m)){let g=m.slice(P.length);this.stateCache[g]=U(p.newValue),c.push(g)}else if(Ee(m)){let g=m.slice(F.length);this.itemsCache[g]=V(p.newValue)}for(let m of c)this.callbacks[m]?.forEach(g=>g(this.stateCache[m]))})}onNamespaceChange(t,r){let a=r,c=this.callbacks[t]??(this.callbacks[t]=[]);return c.push(a),()=>{c.splice(c.indexOf(a),1)}}getNamespace(t){return this.stateCache[t]??null}async setNamespace(t,r){this.stateCache[t]=r,await h.default.storage.local.set({[k(t)]:r})}getItem(t,r,a){let c=`${r}:${a}`;return(this.itemsCache[t]??{})[c]??null}async setItem(t,r,a,c){let m=`${r}:${a}`,p=this.itemsCache[t];p[m]=c,await h.default.storage.local.set({[v(t)]:p})}async clear(){await Promise.all([...Object.keys(this.stateCache).map(t=>h.default.storage.local.remove(k(t))),...Object.keys(this.itemsCache).map(t=>h.default.storage.local.remove(v(t)))]),this.stateCache={},this.itemsCache={},this.callbacks={}}};n();i();var Ne={enabled:!0,clientToken:l.DATADOG_CLIENT_TOKEN,applicationId:"3f3bc3b0-8d80-4b31-b4b9-9909de4d243a",service:"browser-ext-frontend",traceSampleRate:1,sessionSampleRate:1},be={enabled:!0,dsn:"https://pub5df2cf131c51c4215f2ca3aa32d4e4b7@sentry-intake.datadoghq.com/1",sampleRate:.1,tracesSampleRate:0,initialScope:{tags:{service:"browser-ext-background",version:T}}};async function B(e,t){await u.init({appVersion:T,sentry:e==="frontend"?{enabled:!1}:be,datadog:e==="frontend"?Ne:{enabled:!1}}),t&&await u.setUser({id:t})}s(B,"initTelemetry");n();i();var G=class{static{s(this,"NetworkLogger")}requests=[];maxRequests=0;allowedDomains=["phantom.app","phantom.com"];ignoredHosts=new Set;ignoredUrls=new Set;ignoredPatterns;init(t={maxRequests:20,ignoredUrls:[],ignoredHosts:[]}){this.maxRequests=t.maxRequests,this.ignoredUrls=new Set(t.ignoredUrls),this.ignoredHosts=new Set(t.ignoredHosts);let r=self.fetch;self.fetch=async(...a)=>{let[c,m]=a,p=m?.method||"GET",g={};if(m?.headers instanceof Headers?m.headers.forEach((A,R)=>{g[R]=A}):Array.isArray(m?.headers)?m.headers.forEach(([A,R])=>{g[A]=R}):g=m?.headers||{},this.shouldIgnoreRequest(c.toString()))return r(...a);let f={id:`${Date.now()}-${Math.random()}`,method:p,url:c.toString(),requestHeaders:g,startTime:Date.now()};this.requests.length>=this.maxRequests&&this.requests.pop(),this.requests.unshift(f);let E=await r(...a),we=await E.clone().text();return f.status=E.status,f.responseHeaders={},E.headers.forEach((A,R)=>{f.responseHeaders[R]=A}),f.endTime=Date.now(),f.response=we,E}}shouldIgnoreRequest(t){try{let r=new URL(t).hostname;return this.ignoredHosts&&this.ignoredHosts.has(r)||this.ignoredUrls&&this.ignoredUrls.has(t)||!this.allowedDomains.some(a=>r.includes(a))?!0:!!(this.ignoredPatterns&&this.ignoredPatterns.some(a=>a.test(t)))}catch{return!0}}getRequests(){return this.requests}clearRequests(){this.requests=[]}setIgnoredHosts(t){this.ignoredHosts=new Set(t)}setIgnoredUrls(t){this.ignoredUrls=new Set(t)}setIgnoredPatterns(t){this.ignoredPatterns=t}clearIgnoredHosts(){this.ignoredHosts=new Set}clearIgnoredUrls(){this.ignoredUrls=new Set}clearIgnoredPatterns(){this.ignoredPatterns=void 0}},ke=new G,ue=ke;var y,Mt=s(e=>{y?.sendEvent(e)},"sendMMKVUpdateEvent"),he=s(()=>y?.getNamespace(K),"getFlagNamespace"),ye=ne(e=>{he()?.updateRemoteState(t=>({overrides:t?.overrides??{},eppoConfig:t?.eppoConfig??{},userId:e})),he()?.invalidate()}),ve=s(async(e,t,r)=>{if(y)return;let a={apiKey:Q,deviceId:t,subjectAttributes:{appVersion:T,platform:"browser-ext",deviceId:t},pollingEnabled:e==="background",analytics:C,logTelemetry:s(c=>{u.addBreadcrumb(x.FeatureFlags,c,z.Info,{skipFileLogger:!0})},"logTelemetry"),telemetry:u};y=await j({backingStore:new O,namespaces:[K.withDeps(a),J.withDeps({legacyStorage:D,migrations:[...de,...ge,...pe]}),X.withDeps({authRepository:r,legacyStorage:D,migrations:[..._,...le]})],initDeadline:e==="frontend"?0:5e3}),e==="background"&&y.sendEvent("idle")},"initializeMMKV"),xt=s(async()=>{y&&await y.reset()},"resetMMKV"),Kt=s(async(e,t)=>{try{let r=await C.getDeviceId();await B(e,r),await ve(e,r,t),await Oe(),$(r)}catch(r){await B(e),u.captureError(r,x.StartUp)}},"telemetryInitializeFeatureFlags"),Oe=s(()=>{let e=w.getMultivariateAssignment("network-logger-config-json");if(e)try{let t=JSON.parse(e),r=Y.parse(t);ue.init({ignoredHosts:r.ignoredHosts,maxRequests:r.maxRequests,ignoredUrls:r.ignoredUrls})}catch(t){console.error("Error initializing network logger",t)}},"initializeNetworkLogging");n();i();var Te=N(b(),1);n();i();var H=N(b(),1);var Me=s(async()=>{let e=q("serviceWorkerMutexAcquire",void 0),t=W(await H.default.runtime.sendMessage(M(e)));if("error"in t)throw new Error(t.error.message);return()=>{let r=q("serviceWorkerMutexRelease",void 0);H.default.runtime.sendMessage(M(r))}},"acquire"),fe=s(async e=>{let t=await Me();try{return await e()}finally{t()}},"runExclusiveWithServiceWorker");n();i();var Se=N(b(),1);var Ae=s(async(e,t,r)=>{let a=await Se.default.identity.launchWebAuthFlow({interactive:r,url:t});if(!re(e,a))return se(e,a);throw new Error("Error fetching auth code")},"fetchExtensionAuthCode");var Re=me(),xe={getClientID:ae,redirectURL:Te.default.identity.getRedirectURL(),fetchAuthorizationCode:s((e,t,r)=>Ae(e,t,r),"fetchAuthorizationCode")},Ke={storage:new ie,signer:{sign:s((e,t)=>Z(Re,e,t),"sign"),getAuthenticationPublicKey:s(e=>Re.getAuthenticationPublicKey(e),"getAuthenticationPublicKey"),getAllSecretIdentifiers:oe},authConfig:xe,queryClient:ce,runExclusive:fe,isLocalTokenValidityCheckEnabled:s(()=>!w.isFeatureEnabled("kill-frontend-local-check"),"isLocalTokenValidityCheckEnabled"),isServerTimeEnabled:s(()=>!w.isFeatureEnabled("kill-frontend-server-time"),"isServerTimeEnabled")},Le=te(Ke);Le.subscribe(ee.UserID,e=>{C.addUserProperties({authUserId:e}),ye(e)});export{ue as a,Mt as b,xt as c,Kt as d,xe as e,Le as f};
//# sourceMappingURL=chunk-7R3NEG4N.js.map
